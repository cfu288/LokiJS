var L=Object.defineProperty;var y=(o,t)=>L(o,"name",{value:t,configurable:!0});var x=(o,t,e)=>{if(!t.has(o))throw TypeError("Cannot "+e)};var K=(o,t,e)=>(x(o,t,"read from private field"),e?e.call(o):t.get(o)),m=(o,t,e)=>{if(t.has(o))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(o):t.set(o,e)},S=(o,t,e,s)=>(x(o,t,"write to private field"),s?s.call(o,e):t.set(o,e),e);var D=(o,t,e)=>new Promise((s,r)=>{var a=i=>{try{c(e.next(i))}catch(l){r(l)}},n=i=>{try{c(e.throw(i))}catch(l){r(l)}},c=i=>i.done?s(i.value):Promise.resolve(i.value).then(a,n);c((e=e.apply(o,t)).next())});var g=typeof window!="undefined"&&!!window.__loki_idb_debug;g&&console.log("DEBUG: Running crypted-indexeddb-adapter in DEBUG mode");if(!window.crypto.subtle)throw alert("Required crypto lib is not availible, are you using SSL?"),new Error("Required crypto lib is not availible");var f=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","_","-"],E=(()=>{let t=new Uint8Array(256);for(let e=0;e<256;++e)t[e]=255;return f.forEach((e,s)=>{t[e.charCodeAt(0)]=s}),t["=".charCodeAt(0)]=0,t})();function v(o){if(o>=E.length)throw new Error("Unable to parse base64 string (code beyond length).");let t=E[o];if(t===255)throw new Error("Unable to parse base64 string (invalid code).");return t}y(v,"getBase64Code");function C(o){let t="",e,s=o.length;for(e=2;e<s;e+=3)t+=f[o[e-2]>>2],t+=f[(o[e-2]&3)<<4|o[e-1]>>4],t+=f[(o[e-1]&15)<<2|o[e]>>6],t+=f[o[e]&63];return e===s+1&&(t+=f[o[e-2]>>2],t+=f[(o[e-2]&3)<<4],t+="=="),e===s&&(t+=f[o[e-2]>>2],t+=f[(o[e-2]&3)<<4|o[e-1]>>4],t+=f[(o[e-1]&15)<<2],t+="="),t}y(C,"bytesToBase64");function B(o){if(o.length%4!==0)throw new Error("Unable to parse base64 string (invalid length).");let t=o.indexOf("=");if(t!==-1&&t<o.length-2)throw new Error("Unable to parse base64 string (octets).");let e=o.endsWith("==")?2:o.endsWith("=")?1:0,s=o.length,r=new Uint8Array(3*(s/4)),a;for(let n=0,c=0;n<s;n+=4,c+=3)a=v(o.charCodeAt(n))<<18|v(o.charCodeAt(n+1))<<12|v(o.charCodeAt(n+2))<<6|v(o.charCodeAt(n+3)),r[c]=a>>16,r[c+1]=a>>8&255,r[c+2]=a&255;return r.subarray(0,r.length-e)}y(B,"base64ToBytes");function R(o,t=new TextEncoder){return C(t.encode(o))}y(R,"base64encode");function q(o,t=new TextDecoder){return t.decode(B(o))}y(q,"base64decode");var V=y(o=>{let t=new TextEncoder;return window.crypto.subtle.importKey("raw",t.encode(o),"PBKDF2",!1,["deriveKey"])},"getPasswordKey"),j=y((o,t,e)=>window.crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:25e4,hash:"SHA-256"},o,{name:"AES-GCM",length:256},!1,e),"deriveKey");function I(o,t){return D(this,null,function*(){g&&console.log(`in encryptData(${o}, ${t}})`);try{let e=window.crypto.getRandomValues(new Uint8Array(16)),s=window.crypto.getRandomValues(new Uint8Array(12)),r=yield V(t),a=yield j(r,e,["encrypt"]),n=yield window.crypto.subtle.encrypt({name:"AES-GCM",iv:s},a,new TextEncoder().encode(o)),c=new Uint8Array(n),i=new Uint8Array(e.byteLength+s.byteLength+c.byteLength);return i.set(e,0),i.set(s,e.byteLength),i.set(c,e.byteLength+s.byteLength),C(i)}catch(e){throw console.log(`Error - ${e}`),e}})}y(I,"encryptData");function U(o,t){return D(this,null,function*(){g&&console.log(`in decryptData(${o}, ${t}})`);try{let e=B(o),s=e.slice(0,16),r=e.slice(16,16+12),a=e.slice(16+12),n=yield V(t),c=yield j(n,s,["decrypt"]),i=yield window.crypto.subtle.decrypt({name:"AES-GCM",iv:r},c,a);return new TextDecoder().decode(i)}catch(e){throw console.log(`Error - ${e}`),e}})}y(U,"decryptData");var w,u=class{constructor(t,e){m(this,w,void 0);if(g&&console.log("Initialized crypted-indexeddb-adapter"),this.app="loki",this.options=e||{},typeof t!="undefined"&&(this.app=t),this.catalog=null,!this.checkAvailability())throw new Error("IndexedDB does not seem to be supported for your environment");e.secret&&S(this,w,e.secret)}setSecret(t){S(this,w,t)}closeDatabase(){this.catalog&&this.catalog.db&&(this.catalog.db.close(),this.catalog.db=null)}checkAvailability(){return!!(typeof indexedDB!="undefined"&&indexedDB)}loadDatabase(t,e){g&&console.debug("loading database");let s=this.app,r=this,a=K(this,w);if(this.catalog===null||this.catalog.db===null){this.catalog=new h(n=>{r.catalog=n,r.loadDatabase(t,e)});return}this.catalog.getAppKey(s,t,n=>{let{id:c,val:i}=n;if(typeof e=="function"){if(c===0){e(null);return}U(i,a).then(d=>{g&&console.debug(`DECRYPTED STRING: ${d}`),e(d)})}else console.log(decryptedDbString)})}saveDatabase(t,e,s){g&&console.debug(`in saveDatabase(${t}, ${e}, ${s})`);let r=this.app,a=this,n=K(this,w);function c(i){i===null&&s(void 0),i&&i.success,s(void 0),a.options.closeAfterSave&&a.closeDatabase()}if(y(c,"saveCallback"),this.catalog===null||this.catalog.db===null){this.catalog=new h(()=>{a.saveDatabase(t,e,c)});return}I(e,n).then(i=>{g&&console.debug(`ENCRYPTED STRING: ${i}`),this.catalog.setAppKey(r,t,i,c)})}deleteDatabase(t,e){let s=this.app,r=this;if(this.catalog===null||this.catalog.db===null){this.catalog=new h(a=>{r.catalog=a,r.deleteDatabase(t,e)});return}this.catalog.getAppKey(s,t,a=>{let n=a.id;n!==0?r.catalog.deleteAppKey(n,e):typeof e=="function"&&e({success:!0})})}deleteDatabasePartitions(t){let e=this;this.getDatabaseList(s=>{s.forEach(r=>{r.startsWith(t)&&e.deleteDatabase(r)})})}getDatabaseList(t){let e=this.app,s=this;if(this.catalog===null||this.catalog.db===null){this.catalog=new h(r=>{s.catalog=r,s.getDatabaseList(t)});return}this.catalog.getAppKeys(e,r=>{let a=[];for(let n=0;n<r.length;n++)a.push(r[n].key);typeof t=="function"?t(a):a.forEach(n=>{console.log(n)})})}getCatalogSummary(t){let e=this.app,s=this;if(this.catalog===null||this.catalog.db===null){this.catalog=new h(r=>{s.catalog=r,s.getCatalogSummary(t)});return}this.catalog.getAllKeys(r=>{let a=[],n,c,i,l,d;for(let p=0;p<r.length;p++)n=r[p],i=n.app||"",l=n.key||"",d=n.val||"",c=i.length*2+l.length*2+d.length+1,a.push({app:n.app,key:n.key,size:c});typeof t=="function"?t(a):a.forEach(p=>{console.log(p)})})}};y(u,"IndexedDBAdapter"),w=new WeakMap;u.prototype.loadKey=u.prototype.loadDatabase;u.prototype.saveKey=u.prototype.saveDatabase;u.prototype.deleteKey=u.prototype.deleteDatabase;u.prototype.getKeyList=u.prototype.getDatabaseList;var h=class{constructor(t){this.db=null,this.initializeLokiCatalog(t)}initializeLokiCatalog(t){let e=indexedDB.open("SylvieCatalog",1),s=this;e.onupgradeneeded=({target:r})=>{let a=r.result;if(a.objectStoreNames.contains("SylvieAKV")&&a.deleteObjectStore("SylvieAKV"),!a.objectStoreNames.contains("SylvieAKV")){let n=a.createObjectStore("SylvieAKV",{keyPath:"id",autoIncrement:!0});n.createIndex("app","app",{unique:!1}),n.createIndex("key","key",{unique:!1}),n.createIndex("appkey","appkey",{unique:!0})}},e.onsuccess=({target:r})=>{s.db=r.result,typeof t=="function"&&t(s)},e.onerror=r=>{throw r}}getAppKey(t,e,s){let n=this.db.transaction(["SylvieAKV"],"readonly").objectStore("SylvieAKV").index("appkey"),c=`${t},${e}`,i=n.get(c);i.onsuccess=(l=>({target:d})=>{let p=d.result;(p===null||typeof p=="undefined")&&(p={id:0,success:!1}),typeof l=="function"?l(p):console.log(p)})(s),i.onerror=(l=>d=>{if(typeof l=="function")l({id:0,success:!1});else throw d})(s)}getAppKeyById(t,e,s){let n=this.db.transaction(["SylvieAKV"],"readonly").objectStore("SylvieAKV").get(t);n.onsuccess=((c,i)=>({target:l})=>{typeof i=="function"?i(l.result,c):console.log(l.result)})(s,e)}setAppKey(t,e,s,r){let n=this.db.transaction(["SylvieAKV"],"readwrite").objectStore("SylvieAKV"),c=n.index("appkey"),i=`${t},${e}`,l=c.get(i);l.onsuccess=({target:d})=>{let p=d.result;p==null?p={app:t,key:e,appkey:`${t},${e}`,val:s}:p.val=s;let A=n.put(p);A.onerror=(b=>$=>{typeof b=="function"?b({success:!1}):(console.error("SylvieCatalog.setAppKey (set) onerror"),console.error(l.error))})(r),A.onsuccess=(b=>$=>{typeof b=="function"&&b({success:!0})})(r)},l.onerror=(d=>p=>{typeof d=="function"?d({success:!1}):(console.error("SylvieCatalog.setAppKey (get) onerror"),console.error(l.error))})(r)}deleteAppKey(t,e){let a=this.db.transaction(["SylvieAKV"],"readwrite").objectStore("SylvieAKV").delete(t);a.onsuccess=(n=>c=>{typeof n=="function"&&n({success:!0})})(e),a.onerror=(n=>c=>{typeof n=="function"?n({success:!1}):(console.error("SylvieCatalog.deleteAppKey raised onerror"),console.error(a.error))})(e)}getAppKeys(t,e){let a=this.db.transaction(["SylvieAKV"],"readonly").objectStore("SylvieAKV").index("app"),n=IDBKeyRange.only(t),c=a.openCursor(n),i=[];c.onsuccess=((l,d)=>({target:p})=>{let A=p.result;if(A){let b=A.value;l.push(b),A.continue()}else typeof d=="function"?d(l):console.log(l)})(i,e),c.onerror=(l=>d=>{typeof l=="function"?l(null):(console.error("SylvieCatalog.getAppKeys raised onerror"),console.error(d))})(e)}getAllKeys(t){let r=this.db.transaction(["SylvieAKV"],"readonly").objectStore("SylvieAKV").openCursor(),a=[];r.onsuccess=((n,c)=>({target:i})=>{let l=i.result;if(l){let d=l.value;n.push(d),l.continue()}else typeof c=="function"?c(n):console.log(n)})(a,t),r.onerror=(n=>c=>{typeof n=="function"&&n(null)})(t)}};y(h,"SylvieCatalog");typeof window!="undefined"&&Object.assign(window,{IndexedDBAdapter:u});export{B as base64ToBytes,q as base64decode,R as base64encode,C as bytesToBase64};
//# sourceMappingURL=crypted-indexeddb-adapter.js.map
