var j=Object.defineProperty;var u=(a,e)=>j(a,"name",{value:e,configurable:!0});var A=(a,e,t)=>{if(!e.has(a))throw TypeError("Cannot "+t)};var h=(a,e,t)=>{if(e.has(a))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(a):e.set(a,t)};var c=(a,e,t)=>(A(a,e,"access private method"),t);import b from"node:fs/promises";import w from"node:fs";import N from"node:readline";import O from"node:stream";var v,x,m,S,g,$,p,P,y=class{constructor(){h(this,v);h(this,m);h(this,g);h(this,p);this.mode="reference",this.dbref=null}exportDatabase(e,t,r){this.dbref=t;let i=c(this,g,$).call(this);c(this,p,P).call(this,e,i,()=>{r({success:!0})})}deleteDatabase(e,t){b.readdir(".").then(r=>{for(let i of r)(i===e||i.startsWith(e+".")===!0)&&b.unlink(i).catch(s=>{t(s)});t({success:!0})}).catch(r=>{t(r)})}loadDatabase(e,t){let r,i,s,l=this;this.dbref=null,b.stat(e).then(o=>{let f;if(!o.isFile()){t(new Error(`${e} is not a valid file.`));return}r=w.createReadStream(e),i=new O,s=N.createInterface(r,i),s.on("line",n=>{if(l.dbref===null&&n!=="")try{l.dbref=JSON.parse(n)}catch(d){f=d}}),s.on("close",()=>{var n;f?t(f):l.dbref.collections.length>0&&c(n=l,m,S).call(n,e,0,()=>{t(l.dbref)})})}).catch(o=>{if(o.code==="ENOENT"){t(null);return}else{t(o);return}})}};u(y,"FsStructuredAdapter"),v=new WeakSet,x=u(function*(e){let t,r;if(e=e||{},Object.hasOwn(e,"partition")||(e.partition=-1),e.partition===-1){for(r=this.dbref.copy(),t=0;t<r.collections.length;t++)r.collections[t].data=[];yield r.serialize({serializationMethod:"normal"});return}if(e.partition>=0){let i,s=this.dbref.collections[e.partition].data.length;for(i=0;i<s;i++)yield JSON.stringify(this.dbref.collections[e.partition].data[i])}},"#generateDestructured"),m=new WeakSet,S=u(function(e,t,r){let i=w.createReadStream(`${e}.${t}`),s=new O,l=N.createInterface(i,s),o=this,f;l.on("line",n=>{if(n!==""){try{f=JSON.parse(n)}catch(d){r(d)}o.dbref.collections[t].data.push(f)}}),l.on("close",n=>{var d;i=null,s=null,l=null,f=null,++t<o.dbref.collections.length?c(d=o,m,S).call(d,e,t,r):r()})},"#loadNextCollection"),g=new WeakSet,$=u(function*(){let e,t=this.dbref.collections.length;for(yield-1,e=0;e<t;e++)this.dbref.collections[e].dirty&&(yield e)},"#getPartition"),p=new WeakSet,P=u(function(e,t,r){let i=this,s=t.next();if(s.done){r();return}let l=e+(s.value===-1?"":`.${s.value}`),o=w.createWriteStream(l);o.on("close",()=>{var n;c(n=i,p,P).call(n,e,t,r)});let f=c(this,v,x).call(this,{partition:s.value});for(let n of f)o.write(`${n}
`);o.end()},"#saveNextPartition");typeof window!="undefined"&&Object.assign(window,{FsStructuredAdapter:y});export{y as FsStructuredAdapter};
//# sourceMappingURL=fs-structured-adapter.js.map
