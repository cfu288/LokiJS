(()=>{var __defProp=Object.defineProperty;var __getOwnPropNames=Object.getOwnPropertyNames;var __require=(x=>typeof require!=="undefined"?require:typeof Proxy!=="undefined"?new Proxy(x,{get:(a,b)=>(typeof require!=="undefined"?require:a)[b]}):x)(function(x){if(typeof require!=="undefined")return require.apply(this,arguments);throw new Error('Dynamic require of "'+x+'" is not supported')});var __commonJS=(cb,mod)=>function __require2(){return mod||(0,cb[__getOwnPropNames(cb)[0]])((mod={exports:{}}).exports,mod),mod.exports};var __export=(target,all)=>{for(var name in all)__defProp(target,name,{get:all[name],enumerable:true})};var require_loki_indexed_adapter=__commonJS({"src/loki-indexed-adapter.js"(exports,module){(function(root,factory){if(typeof define==="function"&&define.amd){define([],factory)}else if(typeof exports==="object"){module.exports=factory()}else{root.LokiIndexedAdapter=factory()}})(exports,function(){return function(){function LokiIndexedAdapter(appname,options){this.app="loki";this.options=options||{};if(typeof appname!=="undefined"){this.app=appname}this.catalog=null;if(!this.checkAvailability()){throw new Error("indexedDB does not seem to be supported for your environment")}}LokiIndexedAdapter.prototype.closeDatabase=function(){if(this.catalog&&this.catalog.db){this.catalog.db.close();this.catalog.db=null}};LokiIndexedAdapter.prototype.checkAvailability=function(){if(typeof indexedDB!=="undefined"&&indexedDB)return true;return false};LokiIndexedAdapter.prototype.loadDatabase=function(dbname,callback){var appName=this.app;var adapter=this;if(this.catalog===null||this.catalog.db===null){this.catalog=new LokiCatalog(function(cat){adapter.catalog=cat;adapter.loadDatabase(dbname,callback)});return}this.catalog.getAppKey(appName,dbname,function(result){if(typeof callback==="function"){if(result.id===0){callback(null);return}callback(result.val)}else{console.log(result.val)}})};LokiIndexedAdapter.prototype.loadKey=LokiIndexedAdapter.prototype.loadDatabase;LokiIndexedAdapter.prototype.saveDatabase=function(dbname,dbstring,callback){var appName=this.app;var adapter=this;function saveCallback(result){if(result&&result.success===true){callback(null)}else{callback(new Error("Error saving database"))}if(adapter.options.closeAfterSave){adapter.closeDatabase()}}if(this.catalog===null||this.catalog.db===null){this.catalog=new LokiCatalog(function(cat){adapter.saveDatabase(dbname,dbstring,saveCallback)});return}this.catalog.setAppKey(appName,dbname,dbstring,saveCallback)};LokiIndexedAdapter.prototype.saveKey=LokiIndexedAdapter.prototype.saveDatabase;LokiIndexedAdapter.prototype.deleteDatabase=function(dbname,callback){var appName=this.app;var adapter=this;if(this.catalog===null||this.catalog.db===null){this.catalog=new LokiCatalog(function(cat){adapter.catalog=cat;adapter.deleteDatabase(dbname,callback)});return}this.catalog.getAppKey(appName,dbname,function(result){var id=result.id;if(id!==0){adapter.catalog.deleteAppKey(id,callback)}else if(typeof callback==="function"){callback({success:true})}})};LokiIndexedAdapter.prototype.deleteKey=LokiIndexedAdapter.prototype.deleteDatabase;LokiIndexedAdapter.prototype.deleteDatabasePartitions=function(dbname){var self=this;this.getDatabaseList(function(result){result.forEach(function(str){if(str.startsWith(dbname)){self.deleteDatabase(str)}})})};LokiIndexedAdapter.prototype.getDatabaseList=function(callback){var appName=this.app;var adapter=this;if(this.catalog===null||this.catalog.db===null){this.catalog=new LokiCatalog(function(cat){adapter.catalog=cat;adapter.getDatabaseList(callback)});return}this.catalog.getAppKeys(appName,function(results){var names=[];for(var idx=0;idx<results.length;idx++){names.push(results[idx].key)}if(typeof callback==="function"){callback(names)}else{names.forEach(function(obj){console.log(obj)})}})};LokiIndexedAdapter.prototype.getKeyList=LokiIndexedAdapter.prototype.getDatabaseList;LokiIndexedAdapter.prototype.getCatalogSummary=function(callback){var appName=this.app;var adapter=this;if(this.catalog===null||this.catalog.db===null){this.catalog=new LokiCatalog(function(cat){adapter.catalog=cat;adapter.getCatalogSummary(callback)});return}this.catalog.getAllKeys(function(results){var entries=[];var obj,size,oapp,okey,oval;for(var idx=0;idx<results.length;idx++){obj=results[idx];oapp=obj.app||"";okey=obj.key||"";oval=obj.val||"";size=oapp.length*2+okey.length*2+oval.length+1;entries.push({"app":obj.app,"key":obj.key,"size":size})}if(typeof callback==="function"){callback(entries)}else{entries.forEach(function(obj2){console.log(obj2)})}})};function LokiCatalog(callback){this.db=null;this.initializeLokiCatalog(callback)}LokiCatalog.prototype.initializeLokiCatalog=function(callback){var openRequest=indexedDB.open("LokiCatalog",1);var cat=this;openRequest.onupgradeneeded=function(e){var thisDB=e.target.result;if(thisDB.objectStoreNames.contains("LokiAKV")){thisDB.deleteObjectStore("LokiAKV")}if(!thisDB.objectStoreNames.contains("LokiAKV")){var objectStore=thisDB.createObjectStore("LokiAKV",{keyPath:"id",autoIncrement:true});objectStore.createIndex("app","app",{unique:false});objectStore.createIndex("key","key",{unique:false});objectStore.createIndex("appkey","appkey",{unique:true})}};openRequest.onsuccess=function(e){cat.db=e.target.result;if(typeof callback==="function")callback(cat)};openRequest.onerror=function(e){throw e}};LokiCatalog.prototype.getAppKey=function(app,key,callback){var transaction=this.db.transaction(["LokiAKV"],"readonly");var store=transaction.objectStore("LokiAKV");var index=store.index("appkey");var appkey=app+","+key;var request=index.get(appkey);request.onsuccess=function(usercallback){return function(e){var lres=e.target.result;if(lres===null||typeof lres==="undefined"){lres={id:0,success:false}}if(typeof usercallback==="function"){usercallback(lres)}else{console.log(lres)}}}(callback);request.onerror=function(usercallback){return function(e){if(typeof usercallback==="function"){usercallback({id:0,success:false})}else{throw e}}}(callback)};LokiCatalog.prototype.getAppKeyById=function(id,callback,data){var transaction=this.db.transaction(["LokiAKV"],"readonly");var store=transaction.objectStore("LokiAKV");var request=store.get(id);request.onsuccess=function(data2,usercallback){return function(e){if(typeof usercallback==="function"){usercallback(e.target.result,data2)}else{console.log(e.target.result)}}}(data,callback)};LokiCatalog.prototype.setAppKey=function(app,key,val,callback){var transaction=this.db.transaction(["LokiAKV"],"readwrite");var store=transaction.objectStore("LokiAKV");var index=store.index("appkey");var appkey=app+","+key;var request=index.get(appkey);request.onsuccess=function(e){var res=e.target.result;if(res===null||res===void 0){res={app,key,appkey:app+","+key,val}}else{res.val=val}var requestPut=store.put(res);requestPut.onerror=function(usercallback){return function(e2){if(typeof usercallback==="function"){usercallback({success:false})}else{console.error("LokiCatalog.setAppKey (set) onerror");console.error(request.error)}}}(callback);requestPut.onsuccess=function(usercallback){return function(e2){if(typeof usercallback==="function"){usercallback({success:true})}}}(callback)};request.onerror=function(usercallback){return function(e){if(typeof usercallback==="function"){usercallback({success:false})}else{console.error("LokiCatalog.setAppKey (get) onerror");console.error(request.error)}}}(callback)};LokiCatalog.prototype.deleteAppKey=function(id,callback){var transaction=this.db.transaction(["LokiAKV"],"readwrite");var store=transaction.objectStore("LokiAKV");var request=store.delete(id);request.onsuccess=function(usercallback){return function(evt){if(typeof usercallback==="function")usercallback({success:true})}}(callback);request.onerror=function(usercallback){return function(evt){if(typeof usercallback==="function"){usercallback({success:false})}else{console.error("LokiCatalog.deleteAppKey raised onerror");console.error(request.error)}}}(callback)};LokiCatalog.prototype.getAppKeys=function(app,callback){var transaction=this.db.transaction(["LokiAKV"],"readonly");var store=transaction.objectStore("LokiAKV");var index=store.index("app");var singleKeyRange=IDBKeyRange.only(app);var cursor=index.openCursor(singleKeyRange);var localdata=[];cursor.onsuccess=function(data,callback2){return function(e){var cursor2=e.target.result;if(cursor2){var currObject=cursor2.value;data.push(currObject);cursor2.continue()}else{if(typeof callback2==="function"){callback2(data)}else{console.log(data)}}}}(localdata,callback);cursor.onerror=function(usercallback){return function(e){if(typeof usercallback==="function"){usercallback(null)}else{console.error("LokiCatalog.getAppKeys raised onerror");console.error(e)}}}(callback)};LokiCatalog.prototype.getAllKeys=function(callback){var transaction=this.db.transaction(["LokiAKV"],"readonly");var store=transaction.objectStore("LokiAKV");var cursor=store.openCursor();var localdata=[];cursor.onsuccess=function(data,callback2){return function(e){var cursor2=e.target.result;if(cursor2){var currObject=cursor2.value;data.push(currObject);cursor2.continue()}else{if(typeof callback2==="function"){callback2(data)}else{console.log(data)}}}}(localdata,callback);cursor.onerror=function(usercallback){return function(e){if(typeof usercallback==="function")usercallback(null)}}(callback)};return LokiIndexedAdapter}()})}});function localStorageAvailable(){try{return window&&window.localStorage!==void 0&&window.localStorage!==null}catch(e){return false}}function LokiLocalStorageAdapter(){}LokiLocalStorageAdapter.prototype.loadDatabase=function loadDatabase(dbname,callback){if(localStorageAvailable()){callback(localStorage.getItem(dbname))}else{callback(new Error("localStorage is not available"))}};LokiLocalStorageAdapter.prototype.saveDatabase=function saveDatabase(dbname,dbstring,callback){if(localStorageAvailable()){localStorage.setItem(dbname,dbstring);callback(null)}else{callback(new Error("localStorage is not available"))}};LokiLocalStorageAdapter.prototype.deleteDatabase=function deleteDatabase(dbname,callback){if(localStorageAvailable()){localStorage.removeItem(dbname);callback(null)}else{callback(new Error("localStorage is not available"))}};function LokiFsAdapter(){try{this.fs=__require("fs")}catch(e){this.fs=null}}LokiFsAdapter.prototype.loadDatabase=function loadDatabase2(dbname,callback){var self=this;this.fs.stat(dbname,function(err,stats){if(!err&&stats.isFile()){self.fs.readFile(dbname,{encoding:"utf8"},function readFileCallback(err2,data){if(err2){callback(new Error(err2))}else{callback(data)}})}else{callback(null)}})};LokiFsAdapter.prototype.saveDatabase=function saveDatabase2(dbname,dbstring,callback){var self=this;var tmpdbname=dbname+"~";this.fs.writeFile(tmpdbname,dbstring,function writeFileCallback(err){if(err){callback(new Error(err))}else{self.fs.rename(tmpdbname,dbname,callback)}})};LokiFsAdapter.prototype.deleteDatabase=function deleteDatabase2(dbname,callback){this.fs.unlink(dbname,function deleteDatabaseCallback(err){if(err){callback(new Error(err))}else{callback()}})};function LokiMemoryAdapter(options){this.hashStore={};this.options=options||{};if(!this.options.hasOwnProperty("asyncResponses")){this.options.asyncResponses=false}if(!this.options.hasOwnProperty("asyncTimeout")){this.options.asyncTimeout=50}}LokiMemoryAdapter.prototype.loadDatabase=function(dbname,callback){var self=this;if(this.options.asyncResponses){setTimeout(function(){if(self.hashStore.hasOwnProperty(dbname)){callback(self.hashStore[dbname].value)}else{callback(null)}},this.options.asyncTimeout)}else{if(this.hashStore.hasOwnProperty(dbname)){callback(this.hashStore[dbname].value)}else{callback(null)}}};LokiMemoryAdapter.prototype.saveDatabase=function(dbname,dbstring,callback){var self=this;var saveCount;if(this.options.asyncResponses){setTimeout(function(){saveCount=self.hashStore.hasOwnProperty(dbname)?self.hashStore[dbname].savecount:0;self.hashStore[dbname]={savecount:saveCount+1,lastsave:new Date,value:dbstring};callback()},this.options.asyncTimeout)}else{saveCount=this.hashStore.hasOwnProperty(dbname)?this.hashStore[dbname].savecount:0;this.hashStore[dbname]={savecount:saveCount+1,lastsave:new Date,value:dbstring};callback()}};LokiMemoryAdapter.prototype.deleteDatabase=function(dbname,callback){if(this.hashStore.hasOwnProperty(dbname)){delete this.hashStore[dbname]}if(typeof callback==="function"){callback()}};function cloneObjectArray(objarray,method){if(method=="parse-stringify"){return clone(objarray,method)}var result=[];for(var i=0,len=objarray.length;i<len;i++){result[i]=clone(objarray[i],method)}return result}function clone(data,method){if(data===null||data===void 0){return null}var cloneMethod=method||"parse-stringify",cloned;switch(cloneMethod){case"parse-stringify":cloned=JSON.parse(JSON.stringify(data));break;case"jquery-extend-deep":cloned=jQuery.extend(true,{},data);break;case"shallow":cloned=Object.create(data.constructor.prototype);Object.keys(data).map(function(i){cloned[i]=data[i]});break;case"shallow-assign":cloned=Object.create(data.constructor.prototype);Object.assign(cloned,data);break;case"shallow-recurse-objects":cloned=clone(data,"shallow");var keys=Object.keys(data);keys.forEach(function(key){if(typeof data[key]==="object"&&data[key].constructor.name==="Object"){cloned[key]=clone(data[key],"shallow-recurse-objects")}else if(Array.isArray(data[key])){cloned[key]=cloneObjectArray(data[key],"shallow-recurse-objects")}});break;default:break}return cloned}function freeze(obj){if(!Object.isFrozen(obj)){Object.freeze(obj)}}function deepFreeze(obj){var prop,i;if(Array.isArray(obj)){for(i=0;i<obj.length;i++){deepFreeze(obj[i])}freeze(obj)}else if(obj!==null&&typeof obj==="object"){for(prop in obj){if(Object.hasOwn(obj,prop)){deepFreeze(obj[prop])}}freeze(obj)}}function unFreeze(obj){if(!Object.isFrozen(obj)){return obj}return clone(obj,"shallow")}var utils_exports={};__export(utils_exports,{copyProperties:()=>copyProperties,getIn:()=>getIn,resolveTransformObject:()=>resolveTransformObject,resolveTransformParams:()=>resolveTransformParams});var copyProperties=function(src,dest){var prop;for(prop in src){dest[prop]=src[prop]}};var resolveTransformObject=function(subObj,params,depth){var prop,pname;if(typeof depth!=="number"){depth=0}if(++depth>=10)return subObj;for(prop in subObj){if(typeof subObj[prop]==="string"&&subObj[prop].indexOf("[%lktxp]")===0){pname=subObj[prop].substring(8);if(Object.hasOwn(params,pname)){subObj[prop]=params[pname]}}else if(typeof subObj[prop]==="object"){subObj[prop]=utils_exports.resolveTransformObject(subObj[prop],params,depth)}}return subObj};var resolveTransformParams=function(transform,params){var idx,clonedStep,resolvedTransform=[];if(typeof params==="undefined")return transform;for(idx=0;idx<transform.length;idx++){clonedStep=clone(transform[idx],"shallow-recurse-objects");resolvedTransform.push(resolveTransformObject(clonedStep,params))}return resolvedTransform};var getIn=function(object,path,usingDotNotation){if(object==null){return void 0}if(!usingDotNotation){return object[path]}if(typeof path==="string"){path=path.split(".")}if(!Array.isArray(path)){throw new Error("path must be a string or array. Found "+typeof path)}var index=0,length=path.length;while(object!=null&&index<length){object=object[path[index++]]}return index&&index==length?object:void 0};function containsCheckFn(a){if(typeof a==="string"||Array.isArray(a)){return function(b){return a.indexOf(b)!==-1}}else if(typeof a==="object"&&a!==null){return function(b){return Object.hasOwn(a,b)}}return null}function dotSubScan(root,paths,fun,value,extra,poffset){var pathOffset=poffset||0;var path=paths[pathOffset];var valueFound=false;var element;if(root!==null&&typeof root==="object"&&path in root){element=root[path]}if(pathOffset+1>=paths.length){valueFound=fun(element,value,extra)}else if(Array.isArray(element)){for(var index=0,len=element.length;index<len;index+=1){valueFound=dotSubScan(element[index],paths,fun,value,extra,pathOffset+1);if(valueFound===true){break}}}else{valueFound=dotSubScan(element,paths,fun,value,extra,pathOffset+1)}return valueFound}var Comparators={aeq:aeqHelper,lt:ltHelper,gt:gtHelper};function aeqHelper(prop1,prop2){var cv1,cv2,t1,t2;if(prop1===prop2)return true;if(!prop1||!prop2||prop1===true||prop2===true||prop1!==prop1||prop2!==prop2){switch(prop1){case void 0:t1=1;break;case null:t1=1;break;case false:t1=3;break;case true:t1=4;break;case"":t1=5;break;default:t1=prop1===prop1?9:0;break}switch(prop2){case void 0:t2=1;break;case null:t2=1;break;case false:t2=3;break;case true:t2=4;break;case"":t2=5;break;default:t2=prop2===prop2?9:0;break}if(t1!==9||t2!==9){return t1===t2}}cv1=Number(prop1);cv2=Number(prop2);if(cv1===cv1||cv2===cv2){return cv1===cv2}cv1=prop1.toString();cv2=prop2.toString();return cv1==cv2}function ltHelper(prop1,prop2,equal){var cv1,cv2,t1,t2;if(!prop1||!prop2||prop1===true||prop2===true||prop1!==prop1||prop2!==prop2){switch(prop1){case void 0:t1=1;break;case null:t1=1;break;case false:t1=3;break;case true:t1=4;break;case"":t1=5;break;default:t1=prop1===prop1?9:0;break}switch(prop2){case void 0:t2=1;break;case null:t2=1;break;case false:t2=3;break;case true:t2=4;break;case"":t2=5;break;default:t2=prop2===prop2?9:0;break}if(t1!==9||t2!==9){return t1===t2?equal:t1<t2}}cv1=Number(prop1);cv2=Number(prop2);if(cv1===cv1&&cv2===cv2){if(cv1<cv2)return true;if(cv1>cv2)return false;return equal}if(cv1===cv1&&cv2!==cv2){return true}if(cv2===cv2&&cv1!==cv1){return false}if(prop1<prop2)return true;if(prop1>prop2)return false;if(prop1==prop2)return equal;cv1=prop1.toString();cv2=prop2.toString();if(cv1<cv2){return true}if(cv1==cv2){return equal}return false}function gtHelper(prop1,prop2,equal){var cv1,cv2,t1,t2;if(!prop1||!prop2||prop1===true||prop2===true||prop1!==prop1||prop2!==prop2){switch(prop1){case void 0:t1=1;break;case null:t1=1;break;case false:t1=3;break;case true:t1=4;break;case"":t1=5;break;default:t1=prop1===prop1?9:0;break}switch(prop2){case void 0:t2=1;break;case null:t2=1;break;case false:t2=3;break;case true:t2=4;break;case"":t2=5;break;default:t2=prop2===prop2?9:0;break}if(t1!==9||t2!==9){return t1===t2?equal:t1>t2}}cv1=Number(prop1);cv2=Number(prop2);if(cv1===cv1&&cv2===cv2){if(cv1>cv2)return true;if(cv1<cv2)return false;return equal}if(cv1===cv1&&cv2!==cv2){return false}if(cv2===cv2&&cv1!==cv1){return true}if(prop1>prop2)return true;if(prop1<prop2)return false;if(prop1==prop2)return equal;cv1=prop1.toString();cv2=prop2.toString();if(cv1>cv2){return true}if(cv1==cv2){return equal}return false}function sortHelper(prop1,prop2,desc){if(Comparators.aeq(prop1,prop2))return 0;if(Comparators.lt(prop1,prop2,false)){return desc?1:-1}if(Comparators.gt(prop1,prop2,false)){return desc?-1:1}return 0}function compoundeval(properties,obj1,obj2){var res=0;var prop,field,val1,val2,arr;for(var i=0,len=properties.length;i<len;i++){prop=properties[i];field=prop[0];if(~field.indexOf(".")){arr=field.split(".");val1=utils_exports.getIn(obj1,arr,true);val2=utils_exports.getIn(obj2,arr,true)}else{val1=obj1[field];val2=obj2[field]}res=sortHelper(val1,val2,prop[1]);if(res!==0){return res}}return 0}function doQueryOp(val,op,record){for(var p in op){if(Object.hasOwn(op,p)){return LokiOps[p](val,op[p],record)}}return false}var LokiOps={$eq:function(a,b){return a===b},$aeq:function(a,b){return a==b},$ne:function(a,b){if(b!==b){return a===a}return a!==b},$dteq:function(a,b){return Comparators.aeq(a,b)},$gt:function(a,b){return Comparators.gt(a,b,false)},$gte:function(a,b){return Comparators.gt(a,b,true)},$lt:function(a,b){return Comparators.lt(a,b,false)},$lte:function(a,b){return Comparators.lt(a,b,true)},$jgt:function(a,b){return a>b},$jgte:function(a,b){return a>=b},$jlt:function(a,b){return a<b},$jlte:function(a,b){return a<=b},$between:function(a,vals){if(a===void 0||a===null)return false;return Comparators.gt(a,vals[0],true)&&Comparators.lt(a,vals[1],true)},$jbetween:function(a,vals){if(a===void 0||a===null)return false;return a>=vals[0]&&a<=vals[1]},$in:function(a,b){return b.indexOf(a)!==-1},$inSet:function(a,b){return b.has(a)},$nin:function(a,b){return b.indexOf(a)===-1},$keyin:function(a,b){return a in b},$nkeyin:function(a,b){return!(a in b)},$definedin:function(a,b){return b[a]!==void 0},$undefinedin:function(a,b){return b[a]===void 0},$regex:function(a,b){return b.test(a)},$containsString:function(a,b){return typeof a==="string"&&a.indexOf(b)!==-1},$containsNone:function(a,b){return!LokiOps.$containsAny(a,b)},$containsAny:function(a,b){var checkFn=containsCheckFn(a);if(checkFn!==null){return Array.isArray(b)?b.some(checkFn):checkFn(b)}return false},$contains:function(a,b){var checkFn=containsCheckFn(a);if(checkFn!==null){return Array.isArray(b)?b.every(checkFn):checkFn(b)}return false},$elemMatch:function(a,b){if(Array.isArray(a)){return a.some(function(item){return Object.keys(b).every(function(property){var filter=b[property];if(!(typeof filter==="object"&&filter)){filter={$eq:filter}}if(property.indexOf(".")!==-1){return dotSubScan(item,property.split("."),doQueryOp,b[property],item)}return doQueryOp(item[property],filter,item)})})}return false},$type:function(a,b,record){var type=typeof a;if(type==="object"){if(Array.isArray(a)){type="array"}else if(a instanceof Date){type="date"}}return typeof b!=="object"?type===b:doQueryOp(type,b,record)},$finite:function(a,b){return b===isFinite(a)},$size:function(a,b,record){if(Array.isArray(a)){return typeof b!=="object"?a.length===b:doQueryOp(a.length,b,record)}return false},$len:function(a,b,record){if(typeof a==="string"){return typeof b!=="object"?a.length===b:doQueryOp(a.length,b,record)}return false},$where:function(a,b){return b(a)===true},$not:function(a,b,record){return!doQueryOp(a,b,record)},$and:function(a,b,record){for(var idx=0,len=b.length;idx<len;idx+=1){if(!doQueryOp(a,b[idx],record)){return false}}return true},$or:function(a,b,record){for(var idx=0,len=b.length;idx<len;idx+=1){if(doQueryOp(a,b[idx],record)){return true}}return false},$exists:function(a,b){if(b){return a!==void 0}else{return a===void 0}}};var valueLevelOps=["$eq","$aeq","$ne","$dteq","$gt","$gte","$lt","$lte","$jgt","$jgte","$jlt","$jlte","$type"];valueLevelOps.forEach(function(op){var fun=LokiOps[op];LokiOps["$"+op]=function(a,spec,record){if(typeof spec==="string"){return fun(a,record[spec])}else if(typeof spec==="function"){return fun(a,spec(record))}else{throw new Error("Invalid argument to $$ matcher")}}});var indexedOps={$eq:LokiOps.$eq,$aeq:true,$dteq:true,$gt:true,$gte:true,$lt:true,$lte:true,$in:true,$between:true};var LokiEventEmitter=class{constructor(){this.addListener=this.on;this.events={};this.asyncListeners=false}on(eventName,listener){let event;var self=this;if(Array.isArray(eventName)){eventName.forEach(currentEventName=>{this.on(currentEventName,listener)});return listener}event=this.events[eventName];if(!event){event=this.events[eventName]=[]}event.push(listener);return listener}emit(eventName,data){let selfArgs;var self=this;if(eventName&&this.events[eventName]){if(this.events[eventName].length){selfArgs=Array.prototype.slice.call(arguments,1);this.events[eventName].forEach(listener=>{if(this.asyncListeners){setTimeout(()=>{listener.apply(self,selfArgs)},1)}else{listener.apply(self,selfArgs)}})}}else{throw new Error(`No event ${eventName} defined`)}}removeListener(eventName,listener){var self=this;if(Array.isArray(eventName)){eventName.forEach(currentEventName=>{this.removeListener(currentEventName,listener)});return}if(this.events[eventName]){const listeners=this.events[eventName];listeners.splice(listeners.indexOf(listener),1)}}};var hasOwnProperty=Object.prototype.hasOwnProperty;function precompileQuery(operator,value){if(operator==="$regex"){if(Array.isArray(value)){value=new RegExp(value[0],value[1])}else if(!(value instanceof RegExp)){value=new RegExp(value)}}else if(typeof value==="object"){for(var key in value){if(key==="$regex"||typeof value[key]==="object"){value[key]=precompileQuery(key,value[key])}}}return value}function isDeepProperty(field){return field.indexOf(".")!==-1}function parseBase10(num){return parseInt(num,10)}function add(a,b){return a+b}function sub(a,b){return a-b}function average(array){return array.reduce(add,0)/array.length}function standardDeviation(values){var avg=average(values);var squareDiffs=values.map(function(value){var diff=value-avg;var sqrDiff=diff*diff;return sqrDiff});var avgSquareDiff=average(squareDiffs);var stdDev=Math.sqrt(avgSquareDiff);return stdDev}function deepProperty(obj,property,isDeep){if(isDeep===false){return obj[property]}var pieces=property.split("."),root=obj;while(pieces.length>0){root=root[pieces.shift()]}return root}function binarySearch(array,item,fun){var lo=0,hi=array.length,compared,mid;while(lo<hi){mid=lo+hi>>1;compared=fun.apply(null,[item,array[mid]]);if(compared===0){return{found:true,index:mid}}else if(compared<0){hi=mid}else{lo=mid+1}}return{found:false,index:hi}}function BSonSort(fun){return function(array,item){return binarySearch(array,item,fun)}}var ExactIndex=class{constructor(exactField){this.index=Object.create(null);this.field=exactField}set(key,val){if(this.index[key]){this.index[key].push(val)}else{this.index[key]=[val]}}remove(key,val){const idxSet=this.index[key];for(const i in idxSet){if(idxSet[i]==val){idxSet.splice(i,1)}}if(idxSet.length<1){this.index[key]=void 0}}get(key){return this.index[key]}clear(){this.index={}}};var UniqueIndex=class{constructor(uniqueField){this.field=uniqueField;this.keyMap=Object.create(null);this.lokiMap=Object.create(null)}set(obj){const fieldValue=obj[this.field];if(fieldValue!==null&&typeof fieldValue!=="undefined"){if(this.keyMap[fieldValue]){throw new Error(`Duplicate key for property ${this.field}: ${fieldValue}`)}else{this.keyMap[fieldValue]=obj;this.lokiMap[obj.$loki]=fieldValue}}}get(key){return this.keyMap[key]}byId(id){return this.keyMap[this.lokiMap[id]]}update(obj,doc){if(this.lokiMap[obj.$loki]!==doc[this.field]){const old=this.lokiMap[obj.$loki];this.set(doc);this.keyMap[old]=void 0}else{this.keyMap[obj[this.field]]=doc}}remove(key){const obj=this.keyMap[key];if(obj!==null&&typeof obj!=="undefined"){this.keyMap[key]=void 0;this.lokiMap[obj.$loki]=void 0}else{throw new Error(`Key is not in unique index: ${this.field}`)}}clear(){this.keyMap=Object.create(null);this.lokiMap=Object.create(null)}};UniqueIndex.prototype.keyMap={};UniqueIndex.prototype.lokiMap={};var Resultset=class{constructor(collection,options){this.branch=Resultset.prototype.copy;this.$or=Resultset.prototype.findOr;this.$and=Resultset.prototype.findAnd;this.options=options||{};this.collection=collection;this.filteredrows=[];this.filterInitialized=false;return this}reset(){if(this.filteredrows.length>0){this.filteredrows=[]}this.filterInitialized=false;return this}toJSON(){const copy=this.copy();copy.collection=null;return copy}limit(qty){if(!this.filterInitialized&&this.filteredrows.length===0){this.filteredrows=this.collection.prepareFullDocIndex()}const rscopy=new Resultset(this.collection);rscopy.filteredrows=this.filteredrows.slice(0,qty);rscopy.filterInitialized=true;return rscopy}offset(pos){if(!this.filterInitialized&&this.filteredrows.length===0){this.filteredrows=this.collection.prepareFullDocIndex()}const rscopy=new Resultset(this.collection);rscopy.filteredrows=this.filteredrows.slice(pos);rscopy.filterInitialized=true;return rscopy}copy(){const result=new Resultset(this.collection);if(this.filteredrows.length>0){result.filteredrows=this.filteredrows.slice()}result.filterInitialized=this.filterInitialized;return result}transform(transform,parameters){let idx;let step;let rs=this;if(typeof transform==="string"){if(Object.hasOwn(this.collection.transforms,transform)){transform=this.collection.transforms[transform]}}if(typeof transform!=="object"||!Array.isArray(transform)){throw new Error("Invalid transform")}if(typeof parameters!=="undefined"){transform=utils_exports.resolveTransformParams(transform,parameters)}for(idx=0;idx<transform.length;idx++){step=transform[idx];switch(step.type){case"find":rs.find(step.value);break;case"where":rs.where(step.value);break;case"simplesort":rs.simplesort(step.property,step.desc||step.options);break;case"compoundsort":rs.compoundsort(step.value);break;case"sort":rs.sort(step.value);break;case"limit":rs=rs.limit(step.value);break;case"offset":rs=rs.offset(step.value);break;case"map":rs=rs.map(step.value,step.dataOptions);break;case"eqJoin":rs=rs.eqJoin(step.joinData,step.leftJoinKey,step.rightJoinKey,step.mapFun,step.dataOptions);break;case"mapReduce":rs=rs.mapReduce(step.mapFunction,step.reduceFunction);break;case"update":rs.update(step.value);break;case"remove":rs.remove();break;default:break}}return rs}sort(comparefun){if(!this.filterInitialized&&this.filteredrows.length===0){this.filteredrows=this.collection.prepareFullDocIndex()}const wrappedComparer=((userComparer,data)=>(a,b)=>userComparer(data[a],data[b]))(comparefun,this.collection.data);this.filteredrows.sort(wrappedComparer);return this}simplesort(propname,options){let eff;let targetEff=10;const dc=this.collection.data.length;const frl=this.filteredrows.length;const hasBinaryIndex=Object.hasOwn(this.collection.binaryIndices,propname);if(typeof options==="undefined"||options===false){options={desc:false}}if(options===true){options={desc:true}}if(frl===0){if(this.filterInitialized){return this}if(Object.hasOwn(this.collection.binaryIndices,propname)){this.collection.ensureIndex(propname);this.filteredrows=this.collection.binaryIndices[propname].values.slice(0);if(options.desc){this.filteredrows.reverse()}return this}else{this.filteredrows=this.collection.prepareFullDocIndex()}}else{if(!options.disableIndexIntersect&&hasBinaryIndex){eff=dc/frl;if(options.useJavascriptSorting){targetEff=6}if(eff<=targetEff||options.forceIndexIntersect){let idx;const fr=this.filteredrows;const io={};for(idx=0;idx<frl;idx++){io[fr[idx]]=true}const pv=this.collection.binaryIndices[propname].values;this.filteredrows=pv.filter(n=>io[n]);if(options.desc){this.filteredrows.reverse()}return this}}}if(options.useJavascriptSorting){return this.sort((obj1,obj2)=>{if(obj1[propname]===obj2[propname])return 0;if(obj1[propname]>obj2[propname])return 1;if(obj1[propname]<obj2[propname])return-1})}const wrappedComparer=((prop,desc,data)=>{let val1;let val2;let arr;return(a,b)=>{if(~prop.indexOf(".")){arr=prop.split(".");val1=utils_exports.getIn(data[a],arr,true);val2=utils_exports.getIn(data[b],arr,true)}else{val1=data[a][prop];val2=data[b][prop]}return sortHelper(val1,val2,desc)}})(propname,options.desc,this.collection.data);this.filteredrows.sort(wrappedComparer);return this}compoundsort(properties){if(properties.length===0){throw new Error("Invalid call to compoundsort, need at least one property")}let prop;if(properties.length===1){prop=properties[0];if(Array.isArray(prop)){return this.simplesort(prop[0],prop[1])}return this.simplesort(prop,false)}for(let i=0,len=properties.length;i<len;i+=1){prop=properties[i];if(!Array.isArray(prop)){properties[i]=[prop,false]}}if(!this.filterInitialized&&this.filteredrows.length===0){this.filteredrows=this.collection.prepareFullDocIndex()}const wrappedComparer=((props,data)=>(a,b)=>compoundeval(props,data[a],data[b]))(properties,this.collection.data);this.filteredrows.sort(wrappedComparer);return this}findOr(expressionArray){let fr=null;let fri=0;let frlen=0;const docset=[];const idxset=[];let idx=0;for(let ei=0,elen=expressionArray.length;ei<elen;ei++){fr=this.branch().find(expressionArray[ei]).filteredrows;frlen=fr.length;for(fri=0;fri<frlen;fri++){idx=fr[fri];if(idxset[idx]===void 0){idxset[idx]=true;docset.push(idx)}}}this.filteredrows=docset;this.filterInitialized=true;return this}findAnd(expressionArray){for(let i=0,len=expressionArray.length;i<len;i++){if(this.count()===0){return this}this.find(expressionArray[i])}return this}find(query,firstOnly){if(this.collection.data.length===0){this.filteredrows=[];this.filterInitialized=true;return this}const queryObject=query||"getAll";let p;let property;let queryObjectOp;let obj;let operator;let value;let key;let searchByIndex=false;const result=[];const filters=[];let index=null;firstOnly=firstOnly||false;if(typeof queryObject==="object"){for(p in queryObject){obj={};obj[p]=queryObject[p];filters.push(obj);if(hasOwnProperty.call(queryObject,p)){property=p;queryObjectOp=queryObject[p]}}if(filters.length>1){return this.find({$and:filters},firstOnly)}}if(!property||queryObject==="getAll"){if(firstOnly){if(this.filterInitialized){this.filteredrows=this.filteredrows.slice(0,1)}else{this.filteredrows=this.collection.data.length>0?[0]:[];this.filterInitialized=true}}return this}if(property==="$and"||property==="$or"){this[property](queryObjectOp);if(firstOnly&&this.filteredrows.length>1){this.filteredrows=this.filteredrows.slice(0,1)}return this}if(queryObjectOp===null||typeof queryObjectOp!=="object"||queryObjectOp instanceof Date){operator="$eq";value=queryObjectOp}else if(typeof queryObjectOp==="object"){for(key in queryObjectOp){if(hasOwnProperty.call(queryObjectOp,key)){operator=key;value=queryObjectOp[key];break}}}else{throw new Error("Do not know what you want to do.")}if(operator==="$regex"||typeof value==="object"){value=precompileQuery(operator,value)}const usingDotNotation=property.includes(".");const doIndexCheck=!this.filterInitialized;if(doIndexCheck&&this.collection.binaryIndices[property]&&indexedOps[operator]){if(this.collection.adaptiveBinaryIndices!==true){this.collection.ensureIndex(property)}searchByIndex=true;index=this.collection.binaryIndices[property]}if(!searchByIndex&&operator==="$in"&&Array.isArray(value)&&typeof Set!=="undefined"){value=new Set(value);operator="$inSet"}const fun=LokiOps[operator];const t=this.collection.data;let i=0;let len=0;let filter;let rowIdx=0;let record;if(this.filterInitialized){filter=this.filteredrows;len=filter.length;if(usingDotNotation){property=property.split(".");for(i=0;i<len;i++){rowIdx=filter[i];record=t[rowIdx];if(dotSubScan(record,property,fun,value,record)){result.push(rowIdx);if(firstOnly){this.filteredrows=result;return this}}}}else{for(i=0;i<len;i++){rowIdx=filter[i];record=t[rowIdx];if(fun(record[property],value,record)){result.push(rowIdx);if(firstOnly){this.filteredrows=result;return this}}}}}else{if(!searchByIndex){len=t.length;if(usingDotNotation){property=property.split(".");for(i=0;i<len;i++){record=t[i];if(dotSubScan(record,property,fun,value,record)){result.push(i);if(firstOnly){this.filteredrows=result;this.filterInitialized=true;return this}}}}else{for(i=0;i<len;i++){record=t[i];if(fun(record[property],value,record)){result.push(i);if(firstOnly){this.filteredrows=result;this.filterInitialized=true;return this}}}}}else{const segm=this.collection.calculateRange(operator,property,value);if(operator!=="$in"){for(i=segm[0];i<=segm[1];i++){if(indexedOps[operator]!==true){if(indexedOps[operator](utils_exports.getIn(t[index.values[i]],property,usingDotNotation),value)){result.push(index.values[i]);if(firstOnly){this.filteredrows=result;this.filterInitialized=true;return this}}}else{result.push(index.values[i]);if(firstOnly){this.filteredrows=result;this.filterInitialized=true;return this}}}}else{for(i=0,len=segm.length;i<len;i++){result.push(index.values[segm[i]]);if(firstOnly){this.filteredrows=result;this.filterInitialized=true;return this}}}}}this.filteredrows=result;this.filterInitialized=true;return this}where(fun){let viewFunction;const result=[];if("function"===typeof fun){viewFunction=fun}else{throw new TypeError("Argument is not a stored view or a function")}if(this.filterInitialized){let j=this.filteredrows.length;while(j--){if(viewFunction(this.collection.data[this.filteredrows[j]])===true){result.push(this.filteredrows[j])}}this.filteredrows=result;return this}else{let k=this.collection.data.length;while(k--){if(viewFunction(this.collection.data[k])===true){result.push(k)}}this.filteredrows=result;this.filterInitialized=true;return this}}count(){if(this.filterInitialized){return this.filteredrows.length}return this.collection.count()}update(updateFunction){if(typeof updateFunction!=="function"){throw new TypeError("Argument is not a function")}if(!this.filterInitialized&&this.filteredrows.length===0){this.filteredrows=this.collection.prepareFullDocIndex()}let obj;const len=this.filteredrows.length;const rcd=this.collection.data;for(let idx=0;idx<len;idx++){if(!this.disableFreeze||this.collection.cloneObjects||!this.collection.disableDeltaChangesApi){obj=clone(rcd[this.filteredrows[idx]],this.collection.cloneMethod);updateFunction(obj);this.collection.update(obj)}else{updateFunction(rcd[this.filteredrows[idx]]);this.collection.update(rcd[this.filteredrows[idx]])}}return this}remove(){if(!this.filterInitialized&&this.filteredrows.length===0){this.filteredrows=this.collection.prepareFullDocIndex()}this.collection.removeBatchByPositions(this.filteredrows);this.filteredrows=[];return this}mapReduce(mapFunction,reduceFunction){return reduceFunction(this.data().map(mapFunction))}eqJoin(joinData,leftJoinKey,rightJoinKey,mapFun,dataOptions){let leftData=[];let leftDataLength;let rightData=[];let rightDataLength;let key;const result=[];const leftKeyisFunction=typeof leftJoinKey==="function";const rightKeyisFunction=typeof rightJoinKey==="function";const joinMap={};leftData=this.data(dataOptions);leftDataLength=leftData.length;if(joinData instanceof Collection){rightData=joinData.chain().data(dataOptions)}else if(joinData instanceof Resultset){let x=new Resultset({},{});x.rightData=joinData.data(dataOptions)}else if(Array.isArray(joinData)){rightData=joinData}else{throw new TypeError("joinData needs to be an array or result set")}rightDataLength=rightData.length;for(let i=0;i<rightDataLength;i++){key=rightKeyisFunction?rightJoinKey(rightData[i]):rightData[i][rightJoinKey];joinMap[key]=rightData[i]}if(!mapFun){mapFun=(left,right)=>({left,right})}for(let j=0;j<leftDataLength;j++){key=leftKeyisFunction?leftJoinKey(leftData[j]):leftData[j][leftJoinKey];result.push(mapFun(leftData[j],joinMap[key]||{}))}this.collection=new Collection("joinData");this.collection.insert(result);this.filteredrows=[];this.filterInitialized=false;return this}data(options){var result=[],data=this.collection.data,obj,len,i,method;options=options||{};if(options.removeMeta&&!options.forceClones){options.forceClones=true;options.forceCloneMethod=options.forceCloneMethod||"shallow"}if(!this.collection.disableDeltaChangesApi&&this.collection.disableFreeze){options.forceClones=true;options.forceCloneMethod="parse-stringify"}if(!this.filterInitialized){if(this.filteredrows.length===0){if(this.collection.cloneObjects||options.forceClones){len=data.length;method=options.forceCloneMethod||this.collection.cloneMethod;for(i=0;i<len;i++){obj=clone(data[i],method);if(options.removeMeta){delete obj.$loki;delete obj.meta}result.push(obj)}return result}else{return data.slice()}}else{this.filterInitialized=true}}var fr=this.filteredrows;len=fr.length;if(this.collection.cloneObjects||options.forceClones){method=options.forceCloneMethod||this.collection.cloneMethod;for(i=0;i<len;i++){obj=clone(data[fr[i]],method);if(options.removeMeta){delete obj.$loki;delete obj.meta}result.push(obj)}}else{for(i=0;i<len;i++){result.push(data[fr[i]])}}return result}map(mapFun,dataOptions){const data=this.data(dataOptions).map(mapFun);this.collection=new Collection("mappedData");this.collection.insert(data);this.filteredrows=[];this.filterInitialized=false;return this}};var DynamicView=class extends LokiEventEmitter{constructor(collection,name,options){super();this.collection=collection;this.name=name;this.rebuildPending=false;this.options=options||{};if(!this.options.hasOwnProperty("persistent")){this.options.persistent=false}if(!this.options.hasOwnProperty("sortPriority")){this.options.sortPriority="passive"}if(!this.options.hasOwnProperty("minRebuildInterval")){this.options.minRebuildInterval=1}this.resultset=new Resultset(collection);this.resultdata=[];this.resultsdirty=false;this.cachedresultset=null;this.filterPipeline=[];if(!this.collection.disableFreeze){Object.freeze(this.filterPipeline)}this.sortFunction=null;this.sortCriteria=null;this.sortCriteriaSimple=null;this.sortDirty=false;this.events={rebuild:[],filter:[],sort:[]}}getSort(){return this.sortFunction||this.sortCriteria||this.sortCriteriaSimple}rematerialize(options){let fpl;let fpi;let idx;options=options||{};this.resultdata=[];this.resultsdirty=true;this.resultset=new Resultset(this.collection);if(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple){this.sortDirty=true}const wasFrozen=Object.isFrozen(this.filterPipeline);if(options.hasOwnProperty("removeWhereFilters")){if(wasFrozen){this.filterPipeline=this.filterPipeline.slice()}fpl=this.filterPipeline.length;fpi=fpl;while(fpi--){if(this.filterPipeline[fpi].type==="where"){if(fpi!==this.filterPipeline.length-1){this.filterPipeline[fpi]=this.filterPipeline[this.filterPipeline.length-1]}this.filterPipeline.length--}}}const ofp=this.filterPipeline;this.filterPipeline=[];fpl=ofp.length;for(idx=0;idx<fpl;idx++){this.applyFind(ofp[idx].val,ofp[idx].uid)}if(wasFrozen){Object.freeze(this.filterPipeline)}this.data();this.emit("rebuild",this);return this}branchResultset(transform,parameters){const rs=this.resultset.branch();if(typeof transform==="undefined"){return rs}return rs.transform(transform,parameters)}toJSON(){const copy=new DynamicView(this.collection,this.name,this.options);copy.resultset=this.resultset;copy.resultdata=[];copy.resultsdirty=true;copy.filterPipeline=this.filterPipeline;copy.sortFunction=this.sortFunction;copy.sortCriteria=this.sortCriteria;copy.sortCriteriaSimple=this.sortCriteriaSimple||null;copy.sortDirty=this.sortDirty;copy.collection=null;return copy}removeFilters(options={}){this.rebuildPending=false;this.resultset.reset();this.resultdata=[];this.resultsdirty=true;this.cachedresultset=null;const wasFrozen=Object.isFrozen(this.filterPipeline);const filterChanged=this.filterPipeline.length>0;this.filterPipeline=[];if(wasFrozen){Object.freeze(this.filterPipeline)}this.sortFunction=null;this.sortCriteria=null;this.sortCriteriaSimple=null;this.sortDirty=false;if(options.queueSortPhase===true){this.queueSortPhase()}if(filterChanged){this.emit("filter")}}applySort(comparefun){this.sortFunction=comparefun;this.sortCriteria=null;this.sortCriteriaSimple=null;this.queueSortPhase();this.emit("sort");return this}applySimpleSort(propname,options){this.sortCriteriaSimple={propname,options:options||false};if(!this.collection.disableFreeze){deepFreeze(this.sortCriteriaSimple)}this.sortCriteria=null;this.sortFunction=null;this.queueSortPhase();this.emit("sort");return this}applySortCriteria(criteria){this.sortCriteria=criteria;if(!this.collection.disableFreeze){deepFreeze(this.sortCriteria)}this.sortCriteriaSimple=null;this.sortFunction=null;this.queueSortPhase();this.emit("sort");return this}startTransaction(){this.cachedresultset=this.resultset.copy();return this}commit(){this.cachedresultset=null;return this}rollback(){this.resultset=this.cachedresultset;if(this.options.persistent){this.resultdata=this.resultset.data();this.emit("rebuild",this)}return this}_indexOfFilterWithId(uid){if(typeof uid==="string"||typeof uid==="number"){for(let idx=0,len=this.filterPipeline.length;idx<len;idx+=1){if(uid===this.filterPipeline[idx].uid){return idx}}}return-1}_addFilter(filter){const wasFrozen=Object.isFrozen(this.filterPipeline);if(wasFrozen){this.filterPipeline=this.filterPipeline.slice()}if(!this.collection.disableFreeze){deepFreeze(filter)}this.filterPipeline.push(filter);if(wasFrozen){Object.freeze(this.filterPipeline)}this.resultset[filter.type](filter.val)}reapplyFilters(){this.resultset.reset();this.cachedresultset=null;if(this.options.persistent){this.resultdata=[];this.resultsdirty=true}const filters=this.filterPipeline;const wasFrozen=Object.isFrozen(filters);this.filterPipeline=[];for(let idx=0,len=filters.length;idx<len;idx+=1){this._addFilter(filters[idx])}if(wasFrozen){Object.freeze(this.filterPipeline)}if(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple){this.queueSortPhase()}else{this.queueRebuildEvent()}this.emit("filter");return this}applyFilter(filter){const idx=this._indexOfFilterWithId(filter.uid);if(idx>=0){const wasFrozen=Object.isFrozen(this.filterPipeline);if(wasFrozen){this.filterPipeline=this.filterPipeline.slice()}this.filterPipeline[idx]=filter;if(wasFrozen){freeze(filter);Object.freeze(this.filterPipeline)}return this.reapplyFilters()}this.cachedresultset=null;if(this.options.persistent){this.resultdata=[];this.resultsdirty=true}this._addFilter(filter);if(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple){this.queueSortPhase()}else{this.queueRebuildEvent()}this.emit("filter");return this}applyFind(query,uid){this.applyFilter({type:"find",val:query,uid});return this}applyWhere(fun,uid){this.applyFilter({type:"where",val:fun,uid});return this}removeFilter(uid){const idx=this._indexOfFilterWithId(uid);if(idx<0){throw new Error(`Dynamic view does not contain a filter with ID: ${uid}`)}const wasFrozen=Object.isFrozen(this.filterPipeline);if(wasFrozen){this.filterPipeline=this.filterPipeline.slice()}this.filterPipeline.splice(idx,1);if(wasFrozen){Object.freeze(this.filterPipeline)}this.reapplyFilters();return this}count(){if(this.resultsdirty){this.resultdata=this.resultset.data()}return this.resultset.count()}data(options){if(this.sortDirty||this.resultsdirty){this.performSortPhase({suppressRebuildEvent:true})}return this.options.persistent?this.resultdata:this.resultset.data(options)}queueRebuildEvent(){if(this.rebuildPending){return}this.rebuildPending=true;const self=this;setTimeout(()=>{if(self.rebuildPending){self.rebuildPending=false;self.emit("rebuild",self)}},this.options.minRebuildInterval)}queueSortPhase(){if(this.sortDirty){return}this.sortDirty=true;const self=this;if(this.options.sortPriority==="active"){setTimeout(()=>{self.performSortPhase()},this.options.minRebuildInterval)}else{this.queueRebuildEvent()}}performSortPhase(options){if(!this.sortDirty&&!this.resultsdirty){return}options=options||{};if(this.sortDirty){if(this.sortFunction){this.resultset.sort(this.sortFunction)}else if(this.sortCriteria){this.resultset.compoundsort(this.sortCriteria)}else if(this.sortCriteriaSimple){this.resultset.simplesort(this.sortCriteriaSimple.propname,this.sortCriteriaSimple.options)}this.sortDirty=false}if(this.options.persistent){this.resultdata=this.resultset.data();this.resultsdirty=false}if(!options.suppressRebuildEvent){this.emit("rebuild",this)}}evaluateDocument(objIndex,isNew){if(!this.resultset.filterInitialized){if(this.options.persistent){this.resultdata=this.resultset.data()}if(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple){this.queueSortPhase()}else{this.queueRebuildEvent()}return}const ofr=this.resultset.filteredrows;const oldPos=isNew?-1:ofr.indexOf(+objIndex);const oldlen=ofr.length;const evalResultset=new Resultset(this.collection);evalResultset.filteredrows=[objIndex];evalResultset.filterInitialized=true;let filter;for(let idx=0,len=this.filterPipeline.length;idx<len;idx++){filter=this.filterPipeline[idx];evalResultset[filter.type](filter.val)}const newPos=evalResultset.filteredrows.length===0?-1:0;if(oldPos===-1&&newPos===-1)return;if(oldPos===-1&&newPos!==-1){ofr.push(objIndex);if(this.options.persistent){this.resultdata.push(this.collection.data[objIndex])}if(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple){this.queueSortPhase()}else{this.queueRebuildEvent()}return}if(oldPos!==-1&&newPos===-1){if(oldPos<oldlen-1){ofr.splice(oldPos,1);if(this.options.persistent){this.resultdata.splice(oldPos,1)}}else{ofr.length=oldlen-1;if(this.options.persistent){this.resultdata.length=oldlen-1}}if(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple){this.queueSortPhase()}else{this.queueRebuildEvent()}return}if(oldPos!==-1&&newPos!==-1){if(this.options.persistent){this.resultdata[oldPos]=this.collection.data[objIndex]}if(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple){this.queueSortPhase()}else{this.queueRebuildEvent()}return}}removeDocument(objIndex){let idx;let rmidx;let rmlen;const rxo={};const fxo={};let adjels=[];const drs=this.resultset;const fr=this.resultset.filteredrows;let frlen=fr.length;if(!this.resultset.filterInitialized){if(this.options.persistent){this.resultdata=this.resultset.data()}if(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple){this.queueSortPhase()}else{this.queueRebuildEvent()}return}if(!Array.isArray(objIndex)){objIndex=[objIndex]}rmlen=objIndex.length;for(rmidx=0;rmidx<rmlen;rmidx++){rxo[objIndex[rmidx]]=true}for(idx=0;idx<frlen;idx++){if(rxo[fr[idx]])fxo[idx]=true}if(Object.keys(fxo).length>0){this.resultset.filteredrows=this.resultset.filteredrows.filter((di,idx2)=>!fxo[idx2]);if(this.options.persistent){this.resultdata=this.resultdata.filter((obj,idx2)=>!fxo[idx2])}if(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple){this.queueSortPhase()}else{this.queueRebuildEvent()}}const filt=idx2=>di=>di<drs.filteredrows[idx2];frlen=drs.filteredrows.length;for(idx=0;idx<frlen;idx++){adjels=objIndex.filter(filt(idx));drs.filteredrows[idx]-=adjels.length}}mapReduce(mapFunction,reduceFunction){return reduceFunction(this.data().map(mapFunction))}};var Collection=class extends LokiEventEmitter{constructor(name,options){super();this.lokiConsoleWrapper={log(message){},warn(message){},error(message){}};this.name=name;this.data=[];this.idIndex=null;this.binaryIndices={};this.constraints={unique:{},exact:{}};this.uniqueNames=[];this.transforms={};this.objType=name;this.dirty=true;this.cachedIndex=null;this.cachedBinaryIndex=null;this.cachedData=null;const self=this;options=options||{};if(options.hasOwnProperty("unique")){if(!Array.isArray(options.unique)){options.unique=[options.unique]}options.unique.forEach(prop=>{self.uniqueNames.push(prop)})}if(options.hasOwnProperty("exact")){options.exact.forEach(prop=>{self.constraints.exact[prop]=new ExactIndex(prop)})}this.adaptiveBinaryIndices=options.hasOwnProperty("adaptiveBinaryIndices")?options.adaptiveBinaryIndices:true;this.transactional=options.hasOwnProperty("transactional")?options.transactional:false;this.cloneObjects=options.hasOwnProperty("clone")?options.clone:false;this.cloneMethod=options.hasOwnProperty("cloneMethod")?options.cloneMethod:"parse-stringify";this.asyncListeners=options.hasOwnProperty("asyncListeners")?options.asyncListeners:false;this.disableMeta=options.hasOwnProperty("disableMeta")?options.disableMeta:false;this.disableChangesApi=options.hasOwnProperty("disableChangesApi")?options.disableChangesApi:true;this.disableDeltaChangesApi=options.hasOwnProperty("disableDeltaChangesApi")?options.disableDeltaChangesApi:true;if(this.disableChangesApi){this.disableDeltaChangesApi=true}this.autoupdate=options.hasOwnProperty("autoupdate")?options.autoupdate:false;this.serializableIndices=options.hasOwnProperty("serializableIndices")?options.serializableIndices:true;this.disableFreeze=options.hasOwnProperty("disableFreeze")?options.disableFreeze:true;this.ttl={age:null,ttlInterval:null,daemon:null};this.setTTL(options.ttl||-1,options.ttlInterval);this.maxId=0;this.DynamicViews=[];this.events={insert:[],update:[],"pre-insert":[],"pre-update":[],close:[],flushbuffer:[],error:[],delete:[],warning:[]};this.changes=[];this.dirtyIds=[];let indices=[];if(options&&options.indices){if(Object.prototype.toString.call(options.indices)==="[object Array]"){indices=options.indices}else if(typeof options.indices==="string"){indices=[options.indices]}else{throw new TypeError("Indices needs to be a string or an array of strings")}}for(let idx=0;idx<indices.length;idx++){this.ensureIndex(indices[idx])}function observerCallback(changes){const changedObjects=new Set;if(!changedObjects.add)changedObjects.add=function(object){if(!this.includes(object))this.push(object);return this};changes.forEach(({object})=>{changedObjects.add(object)});changedObjects.forEach(object=>{if(!hasOwnProperty.call(object,"$loki"))return self.removeAutoUpdateObserver(object);try{self.update(object)}catch(err){console.log(err)}})}this.observerCallback=observerCallback;function getChangeDelta(obj,old){if(old){return getObjectDelta(old,obj)}else{return JSON.parse(JSON.stringify(obj))}}this.getChangeDelta=getChangeDelta;function getObjectDelta(oldObject,newObject){const propertyNames=newObject!==null&&typeof newObject==="object"?Object.keys(newObject):null;if(propertyNames&&propertyNames.length&&!["string","boolean","number"].includes(typeof newObject)){const delta={};for(let i=0;i<propertyNames.length;i++){const propertyName=propertyNames[i];if(newObject.hasOwnProperty(propertyName)){if(!oldObject.hasOwnProperty(propertyName)||self.uniqueNames.includes(propertyName)||propertyName=="$loki"||propertyName=="meta"){delta[propertyName]=newObject[propertyName]}else{const propertyDelta=getObjectDelta(oldObject[propertyName],newObject[propertyName]);if(typeof propertyDelta!=="undefined"){delta[propertyName]=propertyDelta}}}}return Object.keys(delta).length===0?void 0:delta}else{return oldObject===newObject?void 0:newObject}}this.getObjectDelta=getObjectDelta;function flushChanges(){self.changes=[]}this.getChanges=()=>self.changes;this.flushChanges=flushChanges;this.setChangesApi=enabled=>{self.disableChangesApi=!enabled;if(!enabled){self.disableDeltaChangesApi=false}};this.on("delete",function deleteCallback(obj){if(!self.disableChangesApi){self.createChange(self.name,"R",obj)}});this.on("warning",warning=>{self.lokiConsoleWrapper.warn(warning)});flushChanges()}createChange(name,op,obj,old){this.changes.push({name,operation:op,obj:op=="U"&&!this.disableDeltaChangesApi?this.getChangeDelta(obj,old):JSON.parse(JSON.stringify(obj))})}insertMeta(obj){let len;let idx;if(this.disableMeta||!obj){return}if(Array.isArray(obj)){len=obj.length;for(idx=0;idx<len;idx++){if(!obj[idx].hasOwnProperty("meta")){obj[idx].meta={}}obj[idx].meta.created=new Date().getTime();obj[idx].meta.revision=0}return}if(!obj.meta){obj.meta={}}obj.meta.created=new Date().getTime();obj.meta.revision=0}updateMeta(obj){if(this.disableMeta||!obj){return obj}if(!this.disableFreeze){obj=unFreeze(obj);obj.meta=unFreeze(obj.meta)}obj.meta.updated=new Date().getTime();obj.meta.revision+=1;return obj}createInsertChange(obj){this.createChange(this.name,"I",obj)}createUpdateChange(obj,old){this.createChange(this.name,"U",obj,old)}insertMetaWithChange(obj){this.insertMeta(obj);this.createInsertChange(obj)}updateMetaWithChange(obj,old){obj=this.updateMeta(obj);this.createUpdateChange(obj,old);return obj}addAutoUpdateObserver(object){if(!this.autoupdate||typeof Object.observe!=="function")return;Object.observe(object,this.observerCallback,["add","update","delete","reconfigure","setPrototype"])}removeAutoUpdateObserver(object){if(!this.autoupdate||typeof Object.observe!=="function")return;Object.unobserve(object,this.observerCallback)}addTransform(name,transform){if(this.transforms.hasOwnProperty(name)){throw new Error("a transform by that name already exists")}this.transforms[name]=transform}getTransform(name){return this.transforms[name]}setTransform(name,transform){this.transforms[name]=transform}removeTransform(name){delete this.transforms[name]}byExample(template){let k;let obj;let query;query=[];for(k in template){if(!template.hasOwnProperty(k))continue;query.push((obj={},obj[k]=template[k],obj))}return{$and:query}}findObject(template){return this.findOne(this.byExample(template))}findObjects(template){return this.find(this.byExample(template))}ttlDaemonFuncGen(){const collection=this;const age=this.ttl.age;return function ttlDaemon(){const now=Date.now();const toRemove=collection.chain().where(function daemonFilter(member){const timestamp=member.meta.updated||member.meta.created;const diff=now-timestamp;return age<diff});toRemove.remove()}}setTTL(age,interval){if(age<0){clearInterval(this.ttl.daemon)}else{this.ttl.age=age;this.ttl.ttlInterval=interval;this.ttl.daemon=setInterval(this.ttlDaemonFuncGen(),interval)}}prepareFullDocIndex(){const len=this.data.length;const indexes=new Array(len);for(let i=0;i<len;i+=1){indexes[i]=i}return indexes}configureOptions(options={}){if(options.hasOwnProperty("adaptiveBinaryIndices")){this.adaptiveBinaryIndices=options.adaptiveBinaryIndices;if(this.adaptiveBinaryIndices){this.ensureAllIndexes()}}}ensureIndex(property,force){if(typeof force==="undefined"){force=false}if(property===null||property===void 0){throw new Error("Attempting to set index without an associated property")}if(this.binaryIndices[property]&&!force){if(!this.binaryIndices[property].dirty)return}if(this.adaptiveBinaryIndices===true&&this.binaryIndices.hasOwnProperty(property)&&!force){return}const index={name:property,dirty:true,values:this.prepareFullDocIndex()};this.binaryIndices[property]=index;const wrappedComparer=((prop,data)=>{let val1;let val2;const propPath=~prop.indexOf(".")?prop.split("."):false;return(a,b)=>{if(propPath){val1=utils_exports.getIn(data[a],propPath,true);val2=utils_exports.getIn(data[b],propPath,true)}else{val1=data[a][prop];val2=data[b][prop]}if(val1!==val2){if(Comparators.lt(val1,val2,false))return-1;if(Comparators.gt(val1,val2,false))return 1}return 0}})(property,this.data);index.values.sort(wrappedComparer);index.dirty=false;this.dirty=true}checkAllIndexes(options){let key;const bIndices=this.binaryIndices;const results=[];let result;for(key in bIndices){if(hasOwnProperty.call(bIndices,key)){result=this.checkIndex(key,options);if(!result){results.push(key)}}}return results}checkIndex(property,options={}){if(options.randomSamplingFactor&&options.randomSampling!==false){options.randomSampling=true}options.randomSamplingFactor=options.randomSamplingFactor||.1;if(options.randomSamplingFactor<0||options.randomSamplingFactor>1){options.randomSamplingFactor=.1}let valid=true;let idx;let iter;let pos;if(!this.binaryIndices.hasOwnProperty(property)){throw new Error(`called checkIndex on property without an index: ${property}`)}if(!this.adaptiveBinaryIndices){this.ensureIndex(property)}const biv=this.binaryIndices[property].values;const len=biv.length;if(len!==this.data.length){if(options.repair){this.ensureIndex(property,true)}return false}if(len===0){return true}const usingDotNotation=property.includes(".");if(len===1){valid=biv[0]===0}else{if(options.randomSampling){if(!LokiOps.$lte(utils_exports.getIn(this.data[biv[0]],property,usingDotNotation),utils_exports.getIn(this.data[biv[1]],property,usingDotNotation))){valid=false}if(!LokiOps.$lte(utils_exports.getIn(this.data[biv[len-2]],property,usingDotNotation),utils_exports.getIn(this.data[biv[len-1]],property,usingDotNotation))){valid=false}if(valid){iter=Math.floor((len-1)*options.randomSamplingFactor);for(idx=0;idx<iter-1;idx++){pos=Math.floor(Math.random()*(len-1));if(!LokiOps.$lte(utils_exports.getIn(this.data[biv[pos]],property,usingDotNotation),utils_exports.getIn(this.data[biv[pos+1]],property,usingDotNotation))){valid=false;break}}}}else{for(idx=0;idx<len-1;idx++){if(!LokiOps.$lte(utils_exports.getIn(this.data[biv[idx]],property,usingDotNotation),utils_exports.getIn(this.data[biv[idx+1]],property,usingDotNotation))){valid=false;break}}}}if(!valid&&options.repair){this.ensureIndex(property,true)}return valid}getBinaryIndexValues(property){let idx;const idxvals=this.binaryIndices[property].values;const result=[];for(idx=0;idx<idxvals.length;idx++){result.push(utils_exports.getIn(this.data[idxvals[idx]],property,true))}return result}getUniqueIndex(field,force){const index=this.constraints.unique[field];if(!index&&force){return this.ensureUniqueIndex(field)}return index}ensureUniqueIndex(field){let index=this.constraints.unique[field];if(!index){if(!this.uniqueNames.includes(field)){this.uniqueNames.push(field)}}this.constraints.unique[field]=index=new UniqueIndex(field);this.data.forEach(obj=>{index.set(obj)});return index}ensureAllIndexes(force){let key;const bIndices=this.binaryIndices;for(key in bIndices){if(hasOwnProperty.call(bIndices,key)){this.ensureIndex(key,force)}}}flagBinaryIndexesDirty(){let key;const bIndices=this.binaryIndices;for(key in bIndices){if(hasOwnProperty.call(bIndices,key)){bIndices[key].dirty=true}}}flagBinaryIndexDirty(index){if(this.binaryIndices[index])this.binaryIndices[index].dirty=true}count(query){if(!query){return this.data.length}return this.chain().find(query).filteredrows.length}ensureId(){if(this.idIndex){return}const data=this.data;let i=0;const len=data.length;const index=new Array(len);for(i;i<len;i++){index[i]=data[i].$loki}this.idIndex=index}ensureIdAsync(callback){this.async(function(){this.ensureId()},callback)}addDynamicView(name,options){const dv=new DynamicView(this,name,options);this.DynamicViews.push(dv);return dv}removeDynamicView(name){this.DynamicViews=this.DynamicViews.filter(dv=>dv.name!==name)}getDynamicView(name){for(let idx=0;idx<this.DynamicViews.length;idx++){if(this.DynamicViews[idx].name===name){return this.DynamicViews[idx]}}return null}findAndUpdate(filterObject,updateFunction){if(typeof filterObject==="function"){this.updateWhere(filterObject,updateFunction)}else{this.chain().find(filterObject).update(updateFunction)}}findAndRemove(filterObject){this.chain().find(filterObject).remove()}insert(doc,overrideAdaptiveIndices){if(!Array.isArray(doc)){return this.insertOne(doc)}let obj;let results=[];const adaptiveBatchOverride=overrideAdaptiveIndices&&!this.cloneObjects&&this.adaptiveBinaryIndices&&Object.keys(this.binaryIndices).length>0;if(adaptiveBatchOverride){this.adaptiveBinaryIndices=false}try{this.emit("pre-insert",doc);for(let i=0,len=doc.length;i<len;i++){obj=this.insertOne(doc[i],true);if(!obj){return void 0}results.push(obj)}}finally{if(adaptiveBatchOverride){this.ensureAllIndexes();this.adaptiveBinaryIndices=true}}this.emit("insert",results);results=this.cloneObjects?clone(results,this.cloneMethod):results;return results.length===1?results[0]:results}insertOne(doc,bulkInsert){let err=null;if(typeof doc!=="object"){err=new TypeError("Document needs to be an object")}else if(doc===null){err=new TypeError("Object cannot be null")}if(err!==null){this.emit("error",err);throw err}let obj=this.cloneObjects?clone(doc,this.cloneMethod):doc;if(!this.disableFreeze){obj=unFreeze(obj)}if(!this.disableMeta){if(typeof obj.meta==="undefined"){obj.meta={revision:0,created:0}}else if(!this.disableFreeze){obj.meta=unFreeze(obj.meta)}}if(!bulkInsert){this.emit("pre-insert",obj)}if(!this.add(obj)){return void 0}if(this.disableChangesApi){this.insertMeta(obj)}else{this.insertMetaWithChange(obj)}if(!this.disableFreeze){deepFreeze(obj)}const returnObj=this.cloneObjects?clone(obj,this.cloneMethod):obj;if(!bulkInsert){this.emit("insert",returnObj)}this.addAutoUpdateObserver(returnObj);return returnObj}clear(options){const self=this;options=options||{};this.data=[];this.idIndex=null;this.cachedIndex=null;this.cachedBinaryIndex=null;this.cachedData=null;this.maxId=0;this.DynamicViews=[];this.dirty=true;this.constraints={unique:{},exact:{}};if(options.removeIndices===true){this.binaryIndices={};this.uniqueNames=[]}else{const keys=Object.keys(this.binaryIndices);keys.forEach(biname=>{self.binaryIndices[biname].dirty=false;self.binaryIndices[biname].values=[]})}}update(doc){let adaptiveBatchOverride;let k;let len;if(Array.isArray(doc)){len=doc.length;adaptiveBatchOverride=!this.cloneObjects&&this.adaptiveBinaryIndices&&Object.keys(this.binaryIndices).length>0;if(adaptiveBatchOverride){this.adaptiveBinaryIndices=false}try{for(k=0;k<len;k+=1){this.update(doc[k])}}finally{if(adaptiveBatchOverride){this.ensureAllIndexes();this.adaptiveBinaryIndices=true}}return}if(!hasOwnProperty.call(doc,"$loki")){throw new Error("Trying to update unsynced document. Please save the document first by using insert() or addMany()")}try{this.startTransaction();const arr=this.get(doc.$loki,true);let newInternal;const self=this;if(!arr){throw new Error("Trying to update a document not in collection.")}const oldInternal=arr[0];const position=arr[1];newInternal=this.cloneObjects||!this.disableDeltaChangesApi&&this.disableFreeze?clone(doc,this.cloneMethod):doc;this.emit("pre-update",doc);this.uniqueNames.forEach(key2=>{self.getUniqueIndex(key2,true).update(oldInternal,newInternal)});this.data[position]=newInternal;if(newInternal!==doc){this.addAutoUpdateObserver(doc)}for(let idx=0;idx<this.DynamicViews.length;idx++){this.DynamicViews[idx].evaluateDocument(position,false)}let key;if(this.adaptiveBinaryIndices){const bIndices=this.binaryIndices;for(key in bIndices){this.adaptiveBinaryIndexUpdate(position,key)}}else{this.flagBinaryIndexesDirty()}this.idIndex[position]=newInternal.$loki;if(this.isIncremental){this.dirtyIds.push(newInternal.$loki)}this.commit();this.dirty=true;if(this.disableChangesApi){newInternal=this.updateMeta(newInternal)}else{newInternal=this.updateMetaWithChange(newInternal,oldInternal)}if(!this.disableFreeze){deepFreeze(newInternal)}let returnObj;if(this.cloneObjects){returnObj=clone(newInternal,this.cloneMethod)}else{returnObj=newInternal}this.emit("update",returnObj);return returnObj}catch(err){this.rollback();this.lokiConsoleWrapper.error(err.message);this.emit("error",err);throw err}}add(obj){if("object"!==typeof obj){throw new TypeError("Object being added needs to be an object")}if(typeof obj.$loki!=="undefined"){throw new Error("Document is already in collection, please use update()")}try{this.startTransaction();this.maxId++;if(isNaN(this.maxId)){this.maxId=this.data[this.data.length-1].$loki+1}const newId=this.maxId;obj.$loki=newId;if(!this.disableMeta){obj.meta.version=0}for(var i=0,len=this.uniqueNames.length;i<len;i++){this.getUniqueIndex(this.uniqueNames[i],true).set(obj)}if(this.idIndex){this.idIndex.push(newId)}if(this.isIncremental){this.dirtyIds.push(newId)}this.data.push(obj);const addedPos=this.data.length-1;const dvlen=this.DynamicViews.length;for(i=0;i<dvlen;i++){this.DynamicViews[i].evaluateDocument(addedPos,true)}if(this.adaptiveBinaryIndices){const bIndices=this.binaryIndices;for(const key in bIndices){this.adaptiveBinaryIndexInsert(addedPos,key)}}else{this.flagBinaryIndexesDirty()}this.commit();this.dirty=true;return this.cloneObjects?clone(obj,this.cloneMethod):obj}catch(err){this.rollback();this.lokiConsoleWrapper.error(err.message);this.emit("error",err);throw err}}updateWhere(filterFunction,updateFunction){const results=this.where(filterFunction);let i=0;let obj;try{for(i;i<results.length;i++){obj=updateFunction(results[i]);this.update(obj)}}catch(err){this.rollback();this.lokiConsoleWrapper.error(err.message)}}removeWhere(query){let list;if(typeof query==="function"){list=this.data.filter(query);this.remove(list)}else{this.chain().find(query).remove()}}removeDataOnly(){this.remove(this.data.slice())}removeBatchByPositions(positions){const len=positions.length;const xo={};let dlen;let didx;let idx;const bic=Object.keys(this.binaryIndices).length;const uic=Object.keys(this.constraints.unique).length;const adaptiveOverride=this.adaptiveBinaryIndices&&Object.keys(this.binaryIndices).length>0;let doc;const self=this;try{this.startTransaction();this.ensureId();for(idx=0;idx<len;idx++){xo[this.idIndex[positions[idx]]]=true}dlen=this.DynamicViews.length;if(dlen>0||bic>0||uic>0){if(dlen>0){for(didx=0;didx<dlen;didx++){this.DynamicViews[didx].removeDocument(positions)}}if(this.adaptiveBinaryIndices&&!adaptiveOverride){let key;const bIndices=this.binaryIndices;for(key in bIndices){this.adaptiveBinaryIndexRemove(positions,key)}}else{this.flagBinaryIndexesDirty()}if(uic){this.uniqueNames.forEach(key=>{const index=self.getUniqueIndex(key);if(index){for(idx=0;idx<len;idx++){doc=self.data[positions[idx]];if(doc[key]!==null&&doc[key]!==void 0){index.remove(doc[key])}}}})}}if(!this.disableChangesApi||this.events.delete.length>1){for(idx=0;idx<len;idx++){this.emit("delete",this.data[positions[idx]])}}this.data=this.data.filter(({$loki})=>!xo[$loki]);if(this.isIncremental){for(idx=0;idx<len;idx++){this.dirtyIds.push(this.idIndex[positions[idx]])}}this.idIndex=this.idIndex.filter(id=>!xo[id]);if(this.adaptiveBinaryIndices&&adaptiveOverride){this.adaptiveBinaryIndices=false;this.ensureAllIndexes(true);this.adaptiveBinaryIndices=true}this.commit();this.dirty=true}catch(err){this.rollback();if(adaptiveOverride){this.adaptiveBinaryIndices=true}this.lokiConsoleWrapper.error(err.message);this.emit("error",err);return null}}removeBatch(batch){const len=batch.length;const dlen=this.data.length;let idx;const xlt={};const posx=[];for(idx=0;idx<dlen;idx++){xlt[this.data[idx].$loki]=idx}for(idx=0;idx<len;idx++){if(typeof batch[idx]==="object"){posx.push(xlt[batch[idx].$loki])}else{posx.push(xlt[batch[idx]])}}this.removeBatchByPositions(posx)}remove(doc){if(typeof doc==="number"){doc=this.get(doc)}if("object"!==typeof doc){throw new Error("Parameter is not an object")}if(Array.isArray(doc)){this.removeBatch(doc);return}if(!hasOwnProperty.call(doc,"$loki")){throw new Error("Object is not a document stored in the collection")}try{this.startTransaction();const arr=this.get(doc.$loki,true);const position=arr[1];const self=this;this.uniqueNames.forEach(key=>{if(doc[key]!==null&&typeof doc[key]!=="undefined"){const index=self.getUniqueIndex(key);if(index){index.remove(doc[key])}}});for(let idx=0;idx<this.DynamicViews.length;idx++){this.DynamicViews[idx].removeDocument(position)}if(this.adaptiveBinaryIndices){let key;const bIndices=this.binaryIndices;for(key in bIndices){this.adaptiveBinaryIndexRemove(position,key)}}else{this.flagBinaryIndexesDirty()}this.data.splice(position,1);this.removeAutoUpdateObserver(doc);this.idIndex.splice(position,1);if(this.isIncremental){this.dirtyIds.push(doc.$loki)}this.commit();this.dirty=true;this.emit("delete",arr[0]);if(!this.disableFreeze){doc=unFreeze(doc)}delete doc.$loki;delete doc.meta;if(!this.disableFreeze){freeze(doc)}return doc}catch(err){this.rollback();this.lokiConsoleWrapper.error(err.message);this.emit("error",err);return null}}get(id,returnPosition){if(!this.idIndex){this.ensureId()}const retpos=returnPosition||false;const data=this.idIndex;let max=data.length-1;let min=0;let mid=min+max>>1;id=typeof id==="number"?id:parseInt(id,10);if(isNaN(id)){throw new TypeError("Passed id is not an integer")}while(data[min]<data[max]){mid=min+max>>1;if(data[mid]<id){min=mid+1}else{max=mid}}if(max===min&&data[min]===id){if(retpos){return[this.data[min],min]}return this.data[min]}return null}getBinaryIndexPosition(dataPosition,binaryIndexName){const val=utils_exports.getIn(this.data[dataPosition],binaryIndexName,true);const index=this.binaryIndices[binaryIndexName].values;const range=this.calculateRange("$eq",binaryIndexName,val);if(range[0]===0&&range[1]===-1){return null}const min=range[0];const max=range[1];for(let idx=min;idx<=max;idx++){if(index[idx]===dataPosition)return idx}return null}adaptiveBinaryIndexInsert(dataPosition,binaryIndexName){const usingDotNotation=binaryIndexName.includes(".");const index=this.binaryIndices[binaryIndexName].values;let val=utils_exports.getIn(this.data[dataPosition],binaryIndexName,usingDotNotation);if(this.serializableIndices===true&&val instanceof Date){this.data[dataPosition][binaryIndexName]=val.getTime();val=utils_exports.getIn(this.data[dataPosition],binaryIndexName)}const idxPos=index.length===0?0:this.calculateRangeStart(binaryIndexName,val,true,usingDotNotation);this.binaryIndices[binaryIndexName].values.splice(idxPos,0,dataPosition)}adaptiveBinaryIndexUpdate(dataPosition,binaryIndexName){let idxPos;const index=this.binaryIndices[binaryIndexName].values;const len=index.length;for(idxPos=0;idxPos<len;idxPos++){if(index[idxPos]===dataPosition)break}this.binaryIndices[binaryIndexName].values.splice(idxPos,1);this.adaptiveBinaryIndexInsert(dataPosition,binaryIndexName)}adaptiveBinaryIndexRemove(dataPosition,binaryIndexName,removedFromIndexOnly){const bi=this.binaryIndices[binaryIndexName];let len;let idx;let rmidx;let rmlen;const rxo={};let curr;let shift;if(Array.isArray(dataPosition)){rmlen=dataPosition.length;if(rmlen===1){dataPosition=dataPosition[0]}else{for(rmidx=0;rmidx<rmlen;rmidx++){rxo[dataPosition[rmidx]]=true}bi.values=bi.values.filter(di=>!rxo[di]);if(removedFromIndexOnly===true){return}const sortedPositions=dataPosition.slice();sortedPositions.sort((a,b)=>a-b);len=bi.values.length;for(idx=0;idx<len;idx++){curr=bi.values[idx];shift=0;for(rmidx=0;rmidx<rmlen&&curr>sortedPositions[rmidx];rmidx++){shift++}bi.values[idx]-=shift}return}}const idxPos=this.getBinaryIndexPosition(dataPosition,binaryIndexName);if(idxPos===null){return null}bi.values.splice(idxPos,1);if(removedFromIndexOnly===true){return}len=bi.values.length;for(idx=0;idx<len;idx++){if(bi.values[idx]>dataPosition){bi.values[idx]--}}}calculateRangeStart(prop,val,adaptive,usingDotNotation){const rcd=this.data;const index=this.binaryIndices[prop].values;let min=0;let max=index.length-1;let mid=0;if(index.length===0){return-1}while(min<max){mid=min+max>>1;if(Comparators.lt(utils_exports.getIn(rcd[index[mid]],prop,usingDotNotation),val,false)){min=mid+1}else{max=mid}}const lbound=min;if(Comparators.aeq(val,utils_exports.getIn(rcd[index[lbound]],prop,usingDotNotation))){return lbound}if(Comparators.lt(val,utils_exports.getIn(rcd[index[lbound]],prop,usingDotNotation),false)){return adaptive?lbound:lbound-1}return adaptive?lbound+1:lbound}calculateRangeEnd(prop,val,usingDotNotation){const rcd=this.data;const index=this.binaryIndices[prop].values;let min=0;let max=index.length-1;let mid=0;if(index.length===0){return-1}while(min<max){mid=min+max>>1;if(Comparators.lt(val,utils_exports.getIn(rcd[index[mid]],prop,usingDotNotation),false)){max=mid}else{min=mid+1}}const ubound=max;if(Comparators.aeq(val,utils_exports.getIn(rcd[index[ubound]],prop,usingDotNotation))){return ubound}if(Comparators.gt(val,utils_exports.getIn(rcd[index[ubound]],prop,usingDotNotation),false)){return ubound+1}if(Comparators.aeq(val,utils_exports.getIn(rcd[index[ubound-1]],prop,usingDotNotation))){return ubound-1}return ubound}calculateRange(op,prop,val){const rcd=this.data;const index=this.binaryIndices[prop].values;const min=0;const max=index.length-1;let lbound;let lval;let ubound;let uval;if(rcd.length===0){return[0,-1]}const usingDotNotation=prop.includes(".");const minVal=utils_exports.getIn(rcd[index[min]],prop,usingDotNotation);const maxVal=utils_exports.getIn(rcd[index[max]],prop,usingDotNotation);switch(op){case"$eq":case"$aeq":if(Comparators.lt(val,minVal,false)||Comparators.gt(val,maxVal,false)){return[0,-1]}break;case"$dteq":if(Comparators.lt(val,minVal,false)||Comparators.gt(val,maxVal,false)){return[0,-1]}break;case"$gt":if(Comparators.gt(val,maxVal,true)){return[0,-1]}if(Comparators.gt(minVal,val,false)){return[min,max]}break;case"$gte":if(Comparators.gt(val,maxVal,false)){return[0,-1]}if(Comparators.gt(minVal,val,true)){return[min,max]}break;case"$lt":if(Comparators.lt(val,minVal,true)){return[0,-1]}if(Comparators.lt(maxVal,val,false)){return[min,max]}break;case"$lte":if(Comparators.lt(val,minVal,false)){return[0,-1]}if(Comparators.lt(maxVal,val,true)){return[min,max]}break;case"$between":if(Comparators.gt(val[0],maxVal,false)){return[0,-1]}if(Comparators.lt(val[1],minVal,false)){return[0,-1]}lbound=this.calculateRangeStart(prop,val[0],false,usingDotNotation);ubound=this.calculateRangeEnd(prop,val[1],usingDotNotation);if(lbound<0)lbound++;if(ubound>max)ubound--;if(!Comparators.gt(utils_exports.getIn(rcd[index[lbound]],prop,usingDotNotation),val[0],true))lbound++;if(!Comparators.lt(utils_exports.getIn(rcd[index[ubound]],prop,usingDotNotation),val[1],true))ubound--;if(ubound<lbound)return[0,-1];return[lbound,ubound];case"$in":{const idxset=[];const segResult=[];for(let j=0,len=val.length;j<len;j++){const seg=this.calculateRange("$eq",prop,val[j]);for(let i=seg[0];i<=seg[1];i++){if(idxset[i]===void 0){idxset[i]=true;segResult.push(i)}}}return segResult}}switch(op){case"$eq":case"$aeq":case"$dteq":case"$gte":case"$lt":lbound=this.calculateRangeStart(prop,val,false,usingDotNotation);lval=utils_exports.getIn(rcd[index[lbound]],prop,usingDotNotation);break;default:break}switch(op){case"$eq":case"$aeq":case"$dteq":case"$lte":case"$gt":ubound=this.calculateRangeEnd(prop,val,usingDotNotation);uval=utils_exports.getIn(rcd[index[ubound]],prop,usingDotNotation);break;default:break}switch(op){case"$eq":case"$aeq":case"$dteq":if(!Comparators.aeq(lval,val)){return[0,-1]}return[lbound,ubound];case"$gt":if(!Comparators.aeq(utils_exports.getIn(rcd[index[ubound]],prop,usingDotNotation),val)){return[ubound,max]}return[ubound+1,max];case"$gte":if(!Comparators.aeq(utils_exports.getIn(rcd[index[lbound]],prop,usingDotNotation),val)){return[lbound+1,max]}return[lbound,max];case"$lt":if(!Comparators.aeq(utils_exports.getIn(rcd[index[lbound]],prop,usingDotNotation),val)){return[min,lbound]}return[min,lbound-1];case"$lte":if(!Comparators.aeq(utils_exports.getIn(rcd[index[ubound]],prop,usingDotNotation),val)){return[min,ubound-1]}return[min,ubound];default:return[0,rcd.length-1]}}by(field,value){let self;if(value===void 0){self=this;return value2=>self.by(field,value2)}const result=this.getUniqueIndex(field,true).get(value);if(!this.cloneObjects){return result}else{return clone(result,this.cloneMethod)}}findOne(query={}){const result=this.chain().find(query,true).data();if(Array.isArray(result)&&result.length===0){return null}else{if(!this.cloneObjects){return result[0]}else{return clone(result[0],this.cloneMethod)}}}chain(transform,parameters){const rs=new Resultset(this);if(typeof transform==="undefined"){return rs}return rs.transform(transform,parameters)}find(query){return this.chain().find(query).data()}findOneUnindexed(prop,value){let i=this.data.length;let doc;while(i--){if(utils_exports.getIn(this.data[i],prop,true)===value){doc=this.data[i];return doc}}return null}startTransaction(){if(this.transactional){this.cachedData=clone(this.data,this.cloneMethod);this.cachedIndex=this.idIndex;this.cachedBinaryIndex=this.binaryIndices;this.cachedDirtyIds=this.dirtyIds;for(let idx=0;idx<this.DynamicViews.length;idx++){this.DynamicViews[idx].startTransaction()}}}commit(){if(this.transactional){this.cachedData=null;this.cachedIndex=null;this.cachedBinaryIndex=null;this.cachedDirtyIds=null;for(let idx=0;idx<this.DynamicViews.length;idx++){this.DynamicViews[idx].commit()}}}rollback(){if(this.transactional){if(this.cachedData!==null&&this.cachedIndex!==null){this.data=this.cachedData;this.idIndex=this.cachedIndex;this.binaryIndices=this.cachedBinaryIndex;this.dirtyIds=this.cachedDirtyIds}for(let idx=0;idx<this.DynamicViews.length;idx++){this.DynamicViews[idx].rollback()}}}async(fun,callback){setTimeout(()=>{if(typeof fun==="function"){fun();callback()}else{throw new TypeError("Argument passed for async execution is not a function")}},0)}where(fun){return this.chain().where(fun).data()}mapReduce(mapFunction,reduceFunction){return reduceFunction(this.data.map(mapFunction))}eqJoin(joinData,leftJoinProp,rightJoinProp,mapFun,dataOptions){return new Resultset(this).eqJoin(joinData,leftJoinProp,rightJoinProp,mapFun,dataOptions)}getStage(name){if(!this.stages[name]){this.stages[name]={}}return this.stages[name]}stage(stageName,obj){const copy=JSON.parse(JSON.stringify(obj));this.getStage(stageName)[obj.$loki]=copy;return copy}commitStage(stageName,message){const stage=this.getStage(stageName);let prop;const timestamp=new Date().getTime();for(prop in stage){this.update(stage[prop]);this.commitLog.push({timestamp,message,data:JSON.parse(JSON.stringify(stage[prop]))})}this.stages[stageName]={}}extract(field){let i=0;const len=this.data.length;const isDotNotation=isDeepProperty(field);const result=[];for(i;i<len;i+=1){result.push(deepProperty(this.data[i],field,isDotNotation))}return result}max(field){return Math.max.apply(null,this.extract(field))}min(field){return Math.min.apply(null,this.extract(field))}maxRecord(field){let i=0;const len=this.data.length;const deep=isDeepProperty(field);const result={index:0,value:void 0};let max;for(i;i<len;i+=1){if(max!==void 0){if(max<deepProperty(this.data[i],field,deep)){max=deepProperty(this.data[i],field,deep);result.index=this.data[i].$loki}}else{max=deepProperty(this.data[i],field,deep);result.index=this.data[i].$loki}}result.value=max;return result}minRecord(field){let i=0;const len=this.data.length;const deep=isDeepProperty(field);const result={index:0,value:void 0};let min;for(i;i<len;i+=1){if(min!==void 0){if(min>deepProperty(this.data[i],field,deep)){min=deepProperty(this.data[i],field,deep);result.index=this.data[i].$loki}}else{min=deepProperty(this.data[i],field,deep);result.index=this.data[i].$loki}}result.value=min;return result}extractNumerical(field){return this.extract(field).map(parseBase10).filter(Number).filter(n=>!isNaN(n))}avg(field){return average(this.extractNumerical(field))}stdDev(field){return standardDeviation(this.extractNumerical(field))}mode(field){const dict={};const data=this.extract(field);data.forEach(obj=>{if(dict[obj]){dict[obj]+=1}else{dict[obj]=1}});let max;let prop;let mode;for(prop in dict){if(max){if(max<dict[prop]){mode=prop}}else{mode=prop;max=dict[prop]}}return mode}median(field){const values=this.extractNumerical(field);values.sort(sub);const half=Math.floor(values.length/2);if(values.length%2){return values[half]}else{return(values[half-1]+values[half])/2}}};Collection.prototype.contructor=Collection;Collection.prototype.stages={};Collection.prototype.commitLog=[];Collection.prototype.no_op=function(){return};function KeyValueStore(){}KeyValueStore.prototype={keys:[],values:[],sort:function(a,b){return a<b?-1:a>b?1:0},setSort:function(fun){this.bs=BSonSort(fun)},bs:function(){return BSonSort(this.sort)},set:function(key,value){var pos=this.bs(this.keys,key);if(pos.found){this.values[pos.index]=value}else{this.keys.splice(pos.index,0,key);this.values.splice(pos.index,0,value)}},get:function(key){return this.values[binarySearch(this.keys,key,this.sort).index]}};function LokiPartitioningAdapter(adapter,options){this.mode="reference";this.adapter=null;this.options=options||{};this.dbref=null;this.dbname="";this.pageIterator={};if(adapter){if(adapter.mode==="reference"){throw new Error("LokiPartitioningAdapter cannot be instantiated with a reference mode adapter")}else{this.adapter=adapter}}else{throw new Error("LokiPartitioningAdapter requires a (non-reference mode) adapter on construction")}if(!this.options.hasOwnProperty("paging")){this.options.paging=false}if(!this.options.hasOwnProperty("pageSize")){this.options.pageSize=25*1024*1024}if(!this.options.hasOwnProperty("delimiter")){this.options.delimiter="$<\n"}}LokiPartitioningAdapter.prototype.loadDatabase=function(dbname,callback){var self=this;this.dbname=dbname;this.dbref=new Loki(dbname);this.adapter.loadDatabase(dbname,function(result){if(!result){callback(result);return}if(typeof result!=="string"){callback(new Error("LokiPartitioningAdapter received an unexpected response from inner adapter loadDatabase()"))}var db=JSON.parse(result);self.dbref.loadJSONObject(db);db=null;if(self.dbref.collections.length===0){callback(self.dbref);return}self.pageIterator={collection:0,pageIndex:0};self.loadNextPartition(0,function(){callback(self.dbref)})})};LokiPartitioningAdapter.prototype.loadNextPartition=function(partition,callback){var keyname=this.dbname+"."+partition;var self=this;if(this.options.paging===true){this.pageIterator.pageIndex=0;this.loadNextPage(callback);return}this.adapter.loadDatabase(keyname,function(result){var data=self.dbref.deserializeCollection(result,{delimited:true,collectionIndex:partition});self.dbref.collections[partition].data=data;if(++partition<self.dbref.collections.length){self.loadNextPartition(partition,callback)}else{callback()}})};LokiPartitioningAdapter.prototype.loadNextPage=function(callback){var keyname=this.dbname+"."+this.pageIterator.collection+"."+this.pageIterator.pageIndex;var self=this;this.adapter.loadDatabase(keyname,function(result){var data=result.split(self.options.delimiter);result="";var dlen=data.length;var idx;var isLastPage=data[dlen-1]==="";if(isLastPage){data.pop();dlen=data.length;if(data[dlen-1]===""&&dlen===1){data.pop();dlen=data.length}}for(idx=0;idx<dlen;idx++){self.dbref.collections[self.pageIterator.collection].data.push(JSON.parse(data[idx]));data[idx]=null}data=[];if(isLastPage){if(++self.pageIterator.collection<self.dbref.collections.length){self.loadNextPartition(self.pageIterator.collection,callback)}else{callback()}}else{self.pageIterator.pageIndex++;self.loadNextPage(callback)}})};LokiPartitioningAdapter.prototype.exportDatabase=function(dbname,dbref,callback){var idx,clen=dbref.collections.length;this.dbref=dbref;this.dbname=dbname;this.dirtyPartitions=[-1];for(idx=0;idx<clen;idx++){if(dbref.collections[idx].dirty){this.dirtyPartitions.push(idx)}}this.saveNextPartition(function(err){callback(err)})};LokiPartitioningAdapter.prototype.saveNextPartition=function(callback){var self=this;var partition=this.dirtyPartitions.shift();var keyname=this.dbname+(partition===-1?"":"."+partition);if(this.options.paging&&partition!==-1){this.pageIterator={collection:partition,docIndex:0,pageIndex:0};this.saveNextPage(function(err){if(self.dirtyPartitions.length===0){callback(err)}else{self.saveNextPartition(callback)}});return}var result=this.dbref.serializeDestructured({partitioned:true,delimited:true,partition});this.adapter.saveDatabase(keyname,result,function(err){if(err){callback(err);return}if(self.dirtyPartitions.length===0){callback(null)}else{self.saveNextPartition(callback)}})};LokiPartitioningAdapter.prototype.saveNextPage=function(callback){var self=this;var coll=this.dbref.collections[this.pageIterator.collection];var keyname=this.dbname+"."+this.pageIterator.collection+"."+this.pageIterator.pageIndex;var pageLen=0,cdlen=coll.data.length,delimlen=this.options.delimiter.length;var serializedObject="",pageBuilder="";var doneWithPartition=false,doneWithPage=false;var pageSaveCallback=function(err){pageBuilder="";if(err){callback(err)}if(doneWithPartition){callback(null)}else{self.pageIterator.pageIndex++;self.saveNextPage(callback)}};if(coll.data.length===0){doneWithPartition=true}while(true){if(!doneWithPartition){serializedObject=JSON.stringify(coll.data[this.pageIterator.docIndex]);pageBuilder+=serializedObject;pageLen+=serializedObject.length;if(++this.pageIterator.docIndex>=cdlen)doneWithPartition=true}if(pageLen>=this.options.pageSize)doneWithPage=true;if(!doneWithPage||doneWithPartition){pageBuilder+=this.options.delimiter;pageLen+=delimlen}if(doneWithPartition||doneWithPage){this.adapter.saveDatabase(keyname,pageBuilder,pageSaveCallback);return}}};function Loki(filename,options){this.filename=filename||"loki.db";this.collections=[];this.databaseVersion=1.5;this.engineVersion=1.5;this.autosave=false;this.autosaveInterval=5e3;this.autosaveHandle=null;this.throttledSaves=true;this.options={};this.persistenceMethod=null;this.persistenceAdapter=null;this.throttledSavePending=false;this.throttledCallbacks=[];this.verbose=options&&Object.hasOwn(options,"verbose")?options.verbose:false;this.events={init:[],loaded:[],flushChanges:[],close:[],changes:[],warning:[]};var getENV=function(){if(typeof global!=="undefined"&&(global.android||global.NSObject)){return"NATIVESCRIPT"}if(typeof window==="undefined"){return"NODEJS"}if(typeof global!=="undefined"&&global.window&&typeof process!=="undefined"){return"NODEJS"}if(typeof document!=="undefined"){if(document.URL.indexOf("http://")===-1&&document.URL.indexOf("https://")===-1){return"CORDOVA"}return"BROWSER"}return"CORDOVA"};if(options&&Object.hasOwn(options,"env")){this.ENV=options.env}else{this.ENV=getENV()}if(this.ENV==="undefined"){this.ENV="NODEJS"}this.configureOptions(options,true);this.on("init",this.clearChanges)}Loki.prototype=new LokiEventEmitter;Loki.prototype.constructor=Loki;Loki.prototype.getIndexedAdapter=function(){var adapter;if(typeof __require==="function"){adapter=require_loki_indexed_adapter()}return adapter};Loki.prototype.configureOptions=function(options,initialConfig){var defaultPersistence={NODEJS:"fs",BROWSER:"localStorage",CORDOVA:"localStorage",MEMORY:"memory"},persistenceMethods={fs:LokiFsAdapter,localStorage:LokiLocalStorageAdapter,memory:LokiMemoryAdapter};this.options={};this.persistenceMethod=null;this.persistenceAdapter=null;if(typeof options!=="undefined"){this.options=options;if(Object.hasOwn(this.options,"persistenceMethod")){if(typeof persistenceMethods[options.persistenceMethod]=="function"){this.persistenceMethod=options.persistenceMethod;this.persistenceAdapter=new persistenceMethods[options.persistenceMethod]}}if(Object.hasOwn(this.options,"adapter")){this.persistenceMethod="adapter";this.persistenceAdapter=options.adapter;this.options.adapter=null;this.isIncremental=this.persistenceAdapter.mode==="incremental"}if(options.autoload&&initialConfig){var self=this;setTimeout(function(){self.loadDatabase(options,options.autoloadCallback)},1)}if(Object.hasOwn(this.options,"autosaveInterval")){this.autosaveDisable();this.autosaveInterval=parseInt(this.options.autosaveInterval,10)}if(Object.hasOwn(this.options,"autosave")&&this.options.autosave){this.autosaveDisable();this.autosave=true;if(Object.hasOwn(this.options,"autosaveCallback")){this.autosaveEnable(options,options.autosaveCallback)}else{this.autosaveEnable()}}if(Object.hasOwn(this.options,"throttledSaves")){this.throttledSaves=this.options.throttledSaves}}if(!Object.hasOwn(this.options,"serializationMethod")){this.options.serializationMethod="normal"}if(!Object.hasOwn(this.options,"destructureDelimiter")){this.options.destructureDelimiter="$<\n"}if(this.persistenceAdapter===null){this.persistenceMethod=defaultPersistence[this.ENV];if(this.persistenceMethod){this.persistenceAdapter=new persistenceMethods[this.persistenceMethod]}}};Loki.prototype.copy=function(options){var databaseCopy=new Loki(this.filename,{env:"NA"});var clen,idx;options=options||{};databaseCopy.loadJSONObject(this,{retainDirtyFlags:true});if(options.hasOwnProperty("removeNonSerializable")&&options.removeNonSerializable===true){databaseCopy.autosaveHandle=null;databaseCopy.persistenceAdapter=null;clen=databaseCopy.collections.length;for(idx=0;idx<clen;idx++){databaseCopy.collections[idx].constraints=null;databaseCopy.collections[idx].ttl=null}}return databaseCopy};Loki.prototype.addCollection=function(name,options){var i,len=this.collections.length;if(options&&options.disableMeta===true){if(options.disableChangesApi===false){throw new Error("disableMeta option cannot be passed as true when disableChangesApi is passed as false")}if(options.disableDeltaChangesApi===false){throw new Error("disableMeta option cannot be passed as true when disableDeltaChangesApi is passed as false")}if(typeof options.ttl==="number"&&options.ttl>0){throw new Error("disableMeta option cannot be passed as true when ttl is enabled")}}for(i=0;i<len;i+=1){if(this.collections[i].name===name){return this.collections[i]}}var collection=new Collection(name,options);collection.isIncremental=this.isIncremental;this.collections.push(collection);if(this.verbose)collection.lokiConsoleWrapper=console;return collection};Loki.prototype.loadCollection=function(collection){if(!collection.name){throw new Error("Collection must have a name property to be loaded")}this.collections.push(collection)};Loki.prototype.getCollection=function(collectionName){var i,len=this.collections.length;for(i=0;i<len;i+=1){if(this.collections[i].name===collectionName){return this.collections[i]}}this.emit("warning","collection "+collectionName+" not found");return null};Loki.prototype.renameCollection=function(oldName,newName){var c=this.getCollection(oldName);if(c){c.name=newName}return c};Loki.prototype.listCollections=function(){var i=this.collections.length,colls=[];while(i--){colls.push({name:this.collections[i].name,type:this.collections[i].objType,count:this.collections[i].data.length})}return colls};Loki.prototype.removeCollection=function(collectionName){var i,len=this.collections.length;for(i=0;i<len;i+=1){if(this.collections[i].name===collectionName){var tmpcol=new Collection(collectionName,{});var curcol=this.collections[i];for(var prop in curcol){if(curcol.hasOwnProperty(prop)&&tmpcol.hasOwnProperty(prop)){curcol[prop]=tmpcol[prop]}}this.collections.splice(i,1);return}}};Loki.prototype.getName=function(){return this.name};Loki.prototype.serializeReplacer=function(key,value){switch(key){case"autosaveHandle":case"persistenceAdapter":case"constraints":case"ttl":return null;case"throttledSavePending":case"throttledCallbacks":return void 0;case"lokiConsoleWrapper":return null;default:return value}};Loki.prototype.serialize=function(options){options=options||{};if(!options.hasOwnProperty("serializationMethod")){options.serializationMethod=this.options.serializationMethod}switch(options.serializationMethod){case"normal":return JSON.stringify(this,this.serializeReplacer);case"pretty":return JSON.stringify(this,this.serializeReplacer,2);case"destructured":return this.serializeDestructured();default:return JSON.stringify(this,this.serializeReplacer)}};Loki.prototype.toJson=Loki.prototype.serialize;Loki.prototype.serializeDestructured=function(options){var idx,sidx,result,resultlen;var reconstruct=[];var dbcopy;options=options||{};if(!options.hasOwnProperty("partitioned")){options.partitioned=false}if(!options.hasOwnProperty("delimited")){options.delimited=true}if(!options.hasOwnProperty("delimiter")){options.delimiter=this.options.destructureDelimiter}if(options.partitioned===true&&options.hasOwnProperty("partition")&&options.partition>=0){return this.serializeCollection({delimited:options.delimited,delimiter:options.delimiter,collectionIndex:options.partition})}dbcopy=new Loki(this.filename);dbcopy.loadJSONObject(this);for(idx=0;idx<dbcopy.collections.length;idx++){dbcopy.collections[idx].data=[]}if(options.partitioned===true&&options.partition===-1){return dbcopy.serialize({serializationMethod:"normal"})}reconstruct.push(dbcopy.serialize({serializationMethod:"normal"}));dbcopy=null;for(idx=0;idx<this.collections.length;idx++){result=this.serializeCollection({delimited:options.delimited,delimiter:options.delimiter,collectionIndex:idx});if(options.partitioned===false&&options.delimited===false){if(!Array.isArray(result)){throw new Error("a nondelimited, non partitioned collection serialization did not return an expected array")}resultlen=result.length;for(sidx=0;sidx<resultlen;sidx++){reconstruct.push(result[sidx]);result[sidx]=null}reconstruct.push("")}else{reconstruct.push(result)}}if(options.partitioned){if(options.delimited){return reconstruct}else{return reconstruct}}else{if(options.delimited){reconstruct.push("");return reconstruct.join(options.delimiter)}else{reconstruct.push("");return reconstruct}}};Loki.prototype.serializeCollection=function(options){var doccount,docidx,resultlines=[];options=options||{};if(!options.hasOwnProperty("delimited")){options.delimited=true}if(!options.hasOwnProperty("collectionIndex")){throw new Error("serializeCollection called without 'collectionIndex' option")}doccount=this.collections[options.collectionIndex].data.length;resultlines=[];for(docidx=0;docidx<doccount;docidx++){resultlines.push(JSON.stringify(this.collections[options.collectionIndex].data[docidx]))}if(options.delimited){resultlines.push("");return resultlines.join(options.delimiter)}else{return resultlines}};Loki.prototype.deserializeDestructured=function(destructuredSource,options){var workarray=[];var len,cdb;var collIndex=0,collCount,lineIndex=1,done=false;var currLine,currObject;options=options||{};if(!options.hasOwnProperty("partitioned")){options.partitioned=false}if(!options.hasOwnProperty("delimited")){options.delimited=true}if(!options.hasOwnProperty("delimiter")){options.delimiter=this.options.destructureDelimiter}if(options.partitioned){if(options.hasOwnProperty("partition")){if(options.partition===-1){cdb=JSON.parse(destructuredSource[0]);return cdb}return this.deserializeCollection(destructuredSource[options.partition+1],options)}cdb=JSON.parse(destructuredSource[0]);collCount=cdb.collections.length;for(collIndex=0;collIndex<collCount;collIndex++){cdb.collections[collIndex].data=this.deserializeCollection(destructuredSource[collIndex+1],options)}return cdb}if(options.delimited){workarray=destructuredSource.split(options.delimiter);destructuredSource=null;len=workarray.length;if(len===0){return null}}else{workarray=destructuredSource}cdb=JSON.parse(workarray[0]);collCount=cdb.collections.length;workarray[0]=null;while(!done){currLine=workarray[lineIndex];if(workarray[lineIndex]===""){if(++collIndex>collCount){done=true}}else{currObject=JSON.parse(workarray[lineIndex]);cdb.collections[collIndex].data.push(currObject)}workarray[lineIndex++]=null}return cdb};Loki.prototype.deserializeCollection=function(destructuredSource,options){var workarray=[];var idx,len;options=options||{};if(!options.hasOwnProperty("partitioned")){options.partitioned=false}if(!options.hasOwnProperty("delimited")){options.delimited=true}if(!options.hasOwnProperty("delimiter")){options.delimiter=this.options.destructureDelimiter}if(options.delimited){workarray=destructuredSource.split(options.delimiter);workarray.pop()}else{workarray=destructuredSource}len=workarray.length;for(idx=0;idx<len;idx++){workarray[idx]=JSON.parse(workarray[idx])}return workarray};Loki.prototype.loadJSON=function(serializedDb,options){var dbObject;if(serializedDb.length===0){dbObject={}}else{switch(this.options.serializationMethod){case"normal":case"pretty":dbObject=JSON.parse(serializedDb);break;case"destructured":dbObject=this.deserializeDestructured(serializedDb);break;default:dbObject=JSON.parse(serializedDb);break}}this.loadJSONObject(dbObject,options)};Loki.prototype.loadJSONObject=function(dbObject,options){var i=0,len=dbObject.collections?dbObject.collections.length:0,coll,copyColl,clen,j,loader,collObj;this.name=dbObject.name;if(dbObject.hasOwnProperty("throttledSaves")&&options&&!options.hasOwnProperty("throttledSaves")){this.throttledSaves=dbObject.throttledSaves}this.collections=[];function makeLoader(coll2){var collOptions=options[coll2.name];var inflater;if(collOptions.proto){inflater=collOptions.inflate||utils_exports.copyProperties;return function(data){var collObj2=new collOptions.proto;inflater(data,collObj2);return collObj2}}return collOptions.inflate}for(i;i<len;i+=1){coll=dbObject.collections[i];copyColl=this.addCollection(coll.name,{disableChangesApi:coll.disableChangesApi,disableDeltaChangesApi:coll.disableDeltaChangesApi,disableMeta:coll.disableMeta,disableFreeze:coll.hasOwnProperty("disableFreeze")?coll.disableFreeze:true});copyColl.adaptiveBinaryIndices=coll.hasOwnProperty("adaptiveBinaryIndices")?coll.adaptiveBinaryIndices===true:false;copyColl.transactional=coll.transactional;copyColl.asyncListeners=coll.asyncListeners;copyColl.cloneObjects=coll.cloneObjects;copyColl.cloneMethod=coll.cloneMethod||"parse-stringify";copyColl.autoupdate=coll.autoupdate;copyColl.changes=coll.changes;copyColl.dirtyIds=coll.dirtyIds||[];if(options&&options.retainDirtyFlags===true){copyColl.dirty=coll.dirty}else{copyColl.dirty=false}if(coll.getData){if(options&&options.hasOwnProperty(coll.name)||!copyColl.disableFreeze||copyColl.autoupdate){throw new Error("this collection cannot be loaded lazily: "+coll.name)}copyColl.getData=coll.getData;Object.defineProperty(copyColl,"data",{get:function(){var data=this.getData();this.getData=null;Object.defineProperty(this,"data",{value:data});return data}})}else{clen=coll.data.length;j=0;if(options&&options.hasOwnProperty(coll.name)){loader=makeLoader(coll);for(j;j<clen;j++){collObj=loader(coll.data[j]);copyColl.data[j]=collObj;copyColl.addAutoUpdateObserver(collObj);if(!copyColl.disableFreeze){deepFreeze(copyColl.data[j])}}}else{for(j;j<clen;j++){copyColl.data[j]=coll.data[j];copyColl.addAutoUpdateObserver(copyColl.data[j]);if(!copyColl.disableFreeze){deepFreeze(copyColl.data[j])}}}}copyColl.maxId=typeof coll.maxId==="undefined"?0:coll.maxId;if(typeof coll.binaryIndices!=="undefined"){copyColl.binaryIndices=coll.binaryIndices}if(typeof coll.transforms!=="undefined"){copyColl.transforms=coll.transforms}copyColl.uniqueNames=[];if(coll.hasOwnProperty("uniqueNames")){copyColl.uniqueNames=coll.uniqueNames}if(typeof coll.DynamicViews==="undefined")continue;for(var idx=0;idx<coll.DynamicViews.length;idx++){var colldv=coll.DynamicViews[idx];var dv=copyColl.addDynamicView(colldv.name,colldv.options);dv.resultdata=colldv.resultdata;dv.resultsdirty=colldv.resultsdirty;dv.filterPipeline=colldv.filterPipeline;dv.sortCriteriaSimple=colldv.sortCriteriaSimple;dv.sortCriteria=colldv.sortCriteria;dv.sortFunction=null;dv.sortDirty=colldv.sortDirty;if(!copyColl.disableFreeze){deepFreeze(dv.filterPipeline);if(dv.sortCriteriaSimple){deepFreeze(dv.sortCriteriaSimple)}else if(dv.sortCriteria){deepFreeze(dv.sortCriteria)}}dv.resultset.filteredrows=colldv.resultset.filteredrows;dv.resultset.filterInitialized=colldv.resultset.filterInitialized;dv.rematerialize({removeWhereFilters:true})}if(dbObject.databaseVersion<1.5){copyColl.ensureAllIndexes(true);copyColl.dirty=true}}};Loki.prototype.close=function(callback){if(this.autosave){this.autosaveDisable();if(this.autosaveDirty()){this.saveDatabase(callback);callback=void 0}}if(callback){this.on("close",callback)}this.emit("close")};Loki.prototype.generateChangesNotification=function(arrayOfCollectionNames){function getCollName(coll){return coll.name}var changes=[],selectedCollections=arrayOfCollectionNames||this.collections.map(getCollName);this.collections.forEach(function(coll){if(selectedCollections.indexOf(getCollName(coll))!==-1){changes=changes.concat(coll.getChanges())}});return changes};Loki.prototype.serializeChanges=function(collectionNamesArray){return JSON.stringify(this.generateChangesNotification(collectionNamesArray))};Loki.prototype.clearChanges=function(){this.collections.forEach(function(coll){if(coll.flushChanges){coll.flushChanges()}})};Loki.prototype.throttledSaveDrain=function(callback,options){var self=this;var now=new Date().getTime();if(!this.throttledSaves){callback(true)}options=options||{};if(!options.hasOwnProperty("recursiveWait")){options.recursiveWait=true}if(!options.hasOwnProperty("recursiveWaitLimit")){options.recursiveWaitLimit=false}if(!options.hasOwnProperty("recursiveWaitLimitDuration")){options.recursiveWaitLimitDuration=2e3}if(!options.hasOwnProperty("started")){options.started=new Date().getTime()}if(this.throttledSaves&&this.throttledSavePending){if(options.recursiveWait){this.throttledCallbacks.push(function(){if(self.throttledSavePending){if(options.recursiveWaitLimit&&now-options.started>options.recursiveWaitLimitDuration){callback(false);return}self.throttledSaveDrain(callback,options);return}else{callback(true);return}})}else{this.throttledCallbacks.push(callback);return}}else{callback(true)}};Loki.prototype.loadDatabaseInternal=function(options,callback){var cFun=callback||function(err){if(err){throw err}},self=this;if(this.persistenceAdapter!==null){this.persistenceAdapter.loadDatabase(this.filename,function loadDatabaseCallback(dbString){if(typeof dbString==="string"){var parseSuccess=false;try{self.loadJSON(dbString,options||{});parseSuccess=true}catch(err){cFun(err)}if(parseSuccess){cFun(null);self.emit("loaded","database "+self.filename+" loaded")}}else{if(!dbString){cFun(null);self.emit("loaded","empty database "+self.filename+" loaded");return}if(dbString instanceof Error){cFun(dbString);return}if(typeof dbString==="object"){self.loadJSONObject(dbString,options||{});cFun(null);self.emit("loaded","database "+self.filename+" loaded");return}cFun("unexpected adapter response : "+dbString)}})}else{cFun(new Error("persistenceAdapter not configured"))}};Loki.prototype.loadDatabase=function(options,callback){var self=this;if(!this.throttledSaves){this.loadDatabaseInternal(options,callback);return}this.throttledSaveDrain(function(success){if(success){self.throttledSavePending=true;self.loadDatabaseInternal(options,function(err){if(self.throttledCallbacks.length===0){self.throttledSavePending=false}else{self.saveDatabase()}if(typeof callback==="function"){callback(err)}});return}else{if(typeof callback==="function"){callback(new Error("Unable to pause save throttling long enough to read database"))}}},options)};Loki.prototype.saveDatabaseInternal=function(callback){var cFun=callback||function(err){if(err){throw err}return};var self=this;if(!this.persistenceAdapter){cFun(new Error("persistenceAdapter not configured"));return}if(this.persistenceAdapter.mode==="incremental"){var cachedDirty;this.ignoreAutosave=true;this.persistenceAdapter.saveDatabase(this.filename,function getLokiCopy(){self.ignoreAutosave=false;if(cachedDirty){cFun(new Error("adapter error - getLokiCopy called more than once"));return}var lokiCopy=self.copy({removeNonSerializable:true});cachedDirty=self.collections.map(function(collection){return[collection.dirty,collection.dirtyIds]});self.collections.forEach(function(col){col.dirty=false;col.dirtyIds=[]});return lokiCopy},function exportDatabaseCallback(err){self.ignoreAutosave=false;if(err&&cachedDirty){self.collections.forEach(function(col,i){var cached=cachedDirty[i];col.dirty=col.dirty||cached[0];col.dirtyIds=col.dirtyIds.concat(cached[1])})}cFun(err)})}else if(this.persistenceAdapter.mode==="reference"&&typeof this.persistenceAdapter.exportDatabase==="function"){this.persistenceAdapter.exportDatabase(this.filename,this.copy({removeNonSerializable:true}),function exportDatabaseCallback(err){self.autosaveClearFlags();cFun(err)})}else{this.autosaveClearFlags();this.persistenceAdapter.saveDatabase(this.filename,this.serialize(),function saveDatabasecallback(err){cFun(err)})}};Loki.prototype.saveDatabase=function(callback){if(!this.throttledSaves){this.saveDatabaseInternal(callback);return}if(this.throttledSavePending){this.throttledCallbacks.push(callback);return}var localCallbacks=this.throttledCallbacks;this.throttledCallbacks=[];localCallbacks.unshift(callback);this.throttledSavePending=true;var self=this;this.saveDatabaseInternal(function(err){self.throttledSavePending=false;localCallbacks.forEach(function(pcb){if(typeof pcb==="function"){setTimeout(function(){pcb(err)},1)}});if(self.throttledCallbacks.length>0){self.saveDatabase()}})};Loki.prototype.save=Loki.prototype.saveDatabase;Loki.prototype.deleteDatabase=function(options,callback){var cFun=callback||function(err){if(err){throw err}};if(typeof options==="function"&&!callback){cFun=options}if(this.persistenceAdapter!==null){this.persistenceAdapter.deleteDatabase(this.filename,function deleteDatabaseCallback(err){cFun(err)})}else{cFun(new Error("persistenceAdapter not configured"))}};Loki.prototype.autosaveDirty=function(){for(var idx=0;idx<this.collections.length;idx++){if(this.collections[idx].dirty){return true}}return false};Loki.prototype.autosaveClearFlags=function(){for(var idx=0;idx<this.collections.length;idx++){this.collections[idx].dirty=false}};Loki.prototype.autosaveEnable=function(options,callback){this.autosave=true;var delay=5e3,self=this;if(typeof this.autosaveInterval!=="undefined"&&this.autosaveInterval!==null){delay=this.autosaveInterval}this.autosaveHandle=setInterval(function autosaveHandleInterval(){if(self.autosaveDirty()&&!self.ignoreAutosave){self.saveDatabase(callback)}},delay)};Loki.prototype.autosaveDisable=function(){if(typeof this.autosaveHandle!=="undefined"&&this.autosaveHandle!==null){clearInterval(this.autosaveHandle);this.autosaveHandle=null}};Loki.deepFreeze=deepFreeze;Loki.freeze=freeze;Loki.unFreeze=unFreeze;Loki.LokiOps=LokiOps;Loki.Collection=Collection;Loki.DynamicView=DynamicView;Loki.Resultset=Resultset;Loki.KeyValueStore=KeyValueStore;Loki.LokiMemoryAdapter=LokiMemoryAdapter;Loki.LokiPartitioningAdapter=LokiPartitioningAdapter;Loki.LokiLocalStorageAdapter=LokiLocalStorageAdapter;Loki.LokiFsAdapter=LokiFsAdapter;Loki.persistenceAdapters={fs:LokiFsAdapter,localStorage:LokiLocalStorageAdapter};Loki.aeq=aeqHelper;Loki.lt=ltHelper;Loki.gt=gtHelper;Loki.Comparators=Comparators;window.loki=Loki;})();
//# sourceMappingURL=lokijs.min.js.map
